<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>装饰项目管理系统</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 手势返回锁定提示 -->
    <div class="back-gesture-lock" id="backGestureLock">
        连续2次返回手势可退出
    </div>
    
    <!-- 登录页面 -->
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <h2>立诺装饰 项目管理系统</h2>
            <form id="loginForm">
                <input type="text" id="username" placeholder="用户名" required>
                <input type="password" id="password" placeholder="密码" required>
                <button type="submit">登录</button>                
                <div class="login-error" id="loginError"></div>
            </form>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="container hidden" id="mainContainer">
        <!-- 头部 -->
        <div class="header">
            <div class="header-left">
                <h1>立诺装饰项目管理系统</h1>
                清扬 15662061321
            </div>
            <!-- 顶部4个按钮 - 单行缩小显示 -->
            <div class="header-top-buttons">
                <button class="top-btn btn-info" onclick="saveToGitHub()" title="手动同步到GitHub">
                    保存云端
                </button>
                <button class="top-btn btn-warning" onclick="loadFromGitHub()" title="从GitHub加载">
                    加载云端
                </button>
                <button class="top-btn btn-secondary" onclick="manageGithubConfig()" title="管理GitHub配置">
                    配置管理
                </button>
                <button class="top-btn btn-primary" onclick="showChangeLog()">更改日志</button>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content" id="mainContent">
            <!-- 导入导出 - 下面4个按钮改为2行显示 -->
            <div class="import-export">
                <h3 style="margin-bottom: 12px; color: var(--text-primary); font-size: 16px;">数据管理</h3>
                <div class="button-grid">
                    <div class="button-row">
                        <button class="btn btn-warning" onclick="saveToJsFile()" title="保存为可直接加载的shuju.js文件">
                            备份完整数据
                        </button>
                        <button class="btn btn-primary" onclick="downloadJsonData()" title="下载JSON格式数据">
                            下载JSON数据
                        </button>
                    </div>
                    <div class="button-row">
                        <button class="btn btn-info" onclick="loadFromJsFile()" title="从JSON/JS/ZIP文件加载数据">
                            从文件加载
                        </button>
                        <button class="btn btn-success" onclick="loadImagesZipOnly()" 
                                title="仅加载图片数据包（不覆盖文本）">
                            加载图片包
                        </button>
                    </div>
                </div>
            </div>

            <!-- 用户信息和退出按钮 -->
            <div class="user-info-section">
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>

            <!-- 添加工地按钮 -->
            <button class="add-site-btn" onclick="showAddSiteModal()">+ 添加工地</button>

            <!-- 工地列表 -->
            <div class="site-list" id="siteList"></div>
        </div>

        <!-- 工地详情模态框 -->
        <div class="modal" id="siteModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">工地详情</h3>
                    <button class="close-btn" onclick="closeSiteModal()">&times;</button>
                </div>

                <!-- 标签页容器 -->
                <div class="tabs-container">
                    <div class="tabs-scroll-wrapper">
                        <div class="tabs" id="siteTabs">
                            <!-- 标签页由JS动态生成 -->
                        </div>
                    </div>
                </div>

                <div class="tab-content-wrapper">
                    <!-- 进度标签页 -->
                    <div class="tab-content" id="progressTab">
                        <div class="form-group">
                            <label>工地名称</label>
                            <input type="text" id="siteName" class="form-control" maxlength="25" placeholder="25字符以内">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>开工时间</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="form-group">
                                <label>计划完工时间</label>
                                <input type="date" id="endDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>当前进度: <span id="progressValue">0</span>%</label>
                            <input type="range" id="progress" min="0" max="100" value="0" oninput="updateProgressValue(this.value)">
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSiteInfo()" style="margin-top: 20px;">保存工地信息</button>
                    </div>

                    <!-- 待办事项标签页 - 修改为事项名称和备注各占一行 -->
                    <div class="tab-content" id="todoTab">
                        <h4>待办事项</h4>
                        <!-- 待办事项 - 修改为两个独立的行 -->
                        <div class="form-row" style="flex-wrap: wrap;">
                            <div class="form-group" style="flex: 0 0 100%;">
                                <label>事项名称</label>
                                <input type="text" id="todoItem" maxlength="20" placeholder="20字符以内">
                            </div>
                            <div class="form-group" style="flex: 0 0 100%; margin-top: 15px;">
                                <label>备注说明（20字符以内）</label>
                                <input type="text" id="todoNote" maxlength="20" class="input-note" placeholder="请输入20个以下字符的备注说明">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addTodo()">添加待办</button>
                        <div class="data-table-container">
                            <div id="todoList"></div>
                        </div>
                    </div>

                   <!-- 支出标签页 - 保持金额和备注在同一行 -->
                   <div class="tab-content" id="expenseTab">
                        <h4>支出记录</h4>
                        <div class="expense-row">
                            <div class="form-group">
                                <label>支出项目</label>
                                <input type="text" id="expenseItem" maxlength="8" placeholder="8字符">
                            </div>
                            <div class="form-group">
                                <label>单位</label>
                                <input type="text" id="expenseUnit" maxlength="6" value="项" placeholder="单位" readonly>
                            </div>
                            <div class="form-group amount-group">  <!-- 注意这个有 amount-group 类 -->
                                <label>金额</label>
                                <input type="number" id="expenseAmount" min="0" step="0.01" placeholder="金额">
                            </div>
                            <div class="form-group note-group">  <!-- 新增备注组 -->
                                <label>备注说明</label>
                                <input type="text" id="expenseNote" maxlength="20" class="input-note" placeholder="20字符以内">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addExpense()">添加支出</button>
                        <div class="data-table-container">
                            <div id="expenseList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="requirementTab">
                        <h4>客户要求</h4>
                       <!-- 客户要求 -->
<div class="form-row">
    <div class="form-group">
        <label>要求内容（15字符以下）</label>
        <input type="text" id="requirementContent" maxlength="15" class="input-content" placeholder="请输入15个字符以下的要求内容">
    </div>
    <div class="form-group">
        <label>要求类型</label>
        <select id="requirementType" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary); min-height: 48px;">
            <option value="need">需要</option>
            <option value="exclude">排除</option>
        </select>
    </div>
</div>
<div class="form-row">
    <div class="form-group" style="flex: 0 0 100%;">
        <label>备注说明（20字符以下）</label>
        <input type="text" id="requirementNote" maxlength="20" class="input-note" placeholder="请输入20个字符以下的备注说明">
    </div>
</div>
                        <button class="btn btn-success" onclick="addRequirement()">添加要求</button>
                        <div class="data-table-container">
                            <div id="requirementList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="repairTab">
                        <h4>待维修项</h4>
                       <!-- 维修内容 -->
<div class="form-row">
    <div class="form-group">
        <label>维修内容（10字符以下）</label>
        <input type="text" id="repairContent" maxlength="10" class="input-content" placeholder="请输10个字符以下的维修内容">
    </div>
    <div class="form-group">
        <label>备注说明（20字符以下）</label>
        <input type="text" id="repairNote" maxlength="20" class="input-note" placeholder="请输20个字符以下的备注说明">
    </div>
</div>
                        <div class="form-group">
                            <label>上传照片</label>
                            <div class="file-upload">
                                <input type="file" id="repairPhoto" accept="image/*" onchange="previewRepairPhoto(event)">
                                <label class="file-upload-label">点击上传维修照片</label>
                            </div>
                            <div id="repairPhotoPreview"></div>
                        </div>
                        <button class="btn btn-success" onclick="addRepair()">添加维修项</button>
                        <div class="data-table-container">
                            <div id="repairList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="workerTab">
                        <h4>施工工人</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>姓名</label>
                                <input type="text" id="workerName" maxlength="8" placeholder="8字符">
                            </div>
                            <div class="form-group">
                                <label>工种</label>
                                <input type="text" id="workerType" maxlength="6" placeholder="6字符">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>开始时间</label>
                                <input type="date" id="workerStartTime">
                            </div>
                            <div class="form-group">
                                <label>结束时间</label>
                                <input type="date" id="workerEndTime">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>备注说明（20字符以下）</label>
                            <input  type="text" id="workerNote" maxlength="20" class="input-note" placeholder="请输入20个字符以下的备注说明"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="addWorker()">添加工人</button>
                        <div class="data-table-container">
                            <div id="workerList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="quoteTab">
                        <h4>报价管理</h4>
                        <!-- 报价管理 - 改为行结构 -->
<div class="form-row quote-row">
    <div class="form-group">
        <label>基础装修报价</label>
        <input type="number" id="basicQuote" min="0" step="0.01" placeholder="基础装修报价" ${!canEditQuote() ? 'readonly' : ''}>
    </div>
    <div class="form-group">
        <label>主材报价</label>
        <input type="number" id="materialQuote" min="0" step="0.01" placeholder="主材报价" ${!canEditQuote() ? 'readonly' : ''}>
    </div>
</div>

<div class="form-row quote-row">
    <div class="form-group">
        <label>设备报价</label>
        <input type="number" id="equipmentQuote" min="0" step="0.01" placeholder="设备报价" ${!canEditQuote() ? 'readonly' : ''}>
    </div>
    <div class="form-group">
        <label>家具配饰报价</label>
        <input type="number" id="furnitureQuote" min="0" step="0.01" placeholder="家具配饰报价" ${!canEditQuote() ? 'readonly' : ''}>
    </div>
</div>

<div class="form-row quote-row">
    <div class="form-group">
        <label>其他报价</label>
        <input type="number" id="otherQuote" min="0" step="0.01" placeholder="其他报价" ${!canEditQuote() ? 'readonly' : ''}>
    </div>
    <div class="form-group">
        <label>增减项冲减合计</label>
        <input type="number" id="addRemoveTotalQuote" min="0" step="0.01" placeholder="增减项冲减合计" readonly>
    </div>
</div>
                        <div class="summary-section">
                            <h5>报价汇总</h5>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-label">基础装修报价</div>
                                    <div class="summary-value" id="basicQuoteDisplay">¥0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">主材报价</div>
                                    <div class="summary-value" id="materialQuoteDisplay">¥0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">设备报价</div>
                                    <div class="summary-value" id="equipmentQuoteDisplay">¥0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">家具配饰报价</div>
                                    <div class="summary-value" id="furnitureQuoteDisplay">¥0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">其他报价</div>
                                    <div class="summary-value" id="otherQuoteDisplay">¥0.00</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">增减项冲减合计</div>
                                    <div class="summary-value" id="addRemoveTotalQuoteDisplay">¥0.00</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 8px; text-align: center;">
                                <div style="font-weight: bold; margin-bottom: 5px;">合同总造价</div>
                                <div style="font-size: 20px; font-weight: bold; color: #333;" id="totalQuoteDisplay">¥0.00</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveQuote()" ${!canEditQuote() ? 'disabled' : ''} style="margin-top: 20px;">保存报价</button>
                    </div>

                    <div class="tab-content" id="addRemoveTab">
                        <h4>增减项</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>项目名称</label>
                                <input type="text" id="addRemoveItem" maxlength="8" placeholder="8字符">
                            </div>
                            <div class="form-group">
                                <label>类型</label>
                                <select id="addRemoveType">
                                    <option value="add">增加</option>
                                    <option value="remove">减少</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>单位</label>
                                <input type="text" id="addRemoveUnit" maxlength="4" value="项" placeholder="单位" readonly>
                            </div>
                            <div class="form-group">
                                <label>金额</label>
                                <input type="number" id="addRemoveAmount" min="0" step="0.01" placeholder="金额">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>备注说明（20字符以下）</label>
                            <input type="text" id="addRemoveNote" maxlength="20" class="input-note" placeholder="请输入20个字符以下的备注说明">
                        </div>
                        <button class="btn btn-success" onclick="addAddRemoveItem()">添加增减项</button>
                        <div class="data-table-container">
                            <div id="addRemoveList"></div>
                        </div>
                        <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <h5>增减项冲减合计 = 增项 - 减项</h5>
                            <div style="font-size: 18px; font-weight: bold; color: #333; text-align: center;" id="addRemoveSummary">¥0.00</div>
                        </div>
                    </div>

                    <div class="tab-content" id="drawingTab">
                        <h4>图纸管理</h4>
                        <div class="form-group">
                            <label>图纸类型</label>
                            <select id="drawingType">
                                <option value="design">设计图纸</option>
                                <option value="quote">报价表</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>上传图纸</label>
                            <div class="file-upload">
                                <input type="file" id="drawingFile" accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.doc,.docx,.csv" 
                                       onchange="previewDrawing(event)">
                                <label class="file-upload-label">点击上传图纸（支持PDF、图片、表格格式）</label>
                            </div>
                            <div id="drawingPreview"></div>
                        </div>
                        <div class="form-group">
                            <label>备注说明（20字符以下）</label>
                            <input type="text" id="drawingNote" maxlength="20" class="input-note" placeholder="请输入20个字符以下的备注说明">
                        </div>
                        <button class="btn btn-success" onclick="uploadDrawing()">上传图纸</button>
                        <div class="data-table-container">
                            <div id="drawingList"></div>
                        </div>
                    </div>

                    <div class="tab-content" id="experienceTab">
                        <h4>经验总结</h4>
                        <div class="form-group">
                            <label>经验总结内容</label>
                            <input type="text" id="experienceContent" rows="3" class="input-note" placeholder="请输入项目经验总结..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="addExperience()">添加总结</button>
                        <div id="experienceList" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更改日志页面 -->
<div class="change-log-page" id="changeLogPage">
    <div class="modal-header">
        <h3>更改日志</h3>
        <button class="close-btn" onclick="hideChangeLog()">&times;</button>
    </div>
    
    <!-- 添加一个容器包裹日志列表 -->
    <div style="padding: 16px;">
        <div class="import-export" style="margin-bottom: 16px; padding: 12px;">
            <div class="button-grid">
                <div class="button-row">
                    <button class="btn btn-primary" onclick="exportChangeLog()">导出日志</button>
                    <button class="btn btn-danger" onclick="clearChangeLog()">清空日志</button>
                </div>
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="hideChangeLog()">返回</button>
                </div>
            </div>
        </div>
        <div id="changeLogList"></div>
    </div>
</div>

        <!-- 图片查看器 -->
        <div class="image-viewer" id="imageViewer" onclick="hideImageViewer()">
            <span class="close-viewer">&times;</span>
            <img id="viewerImage" src="" alt="查看图片">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="app-tables-and-utils.js"></script>
    <script src="app-main.js"></script>
</body>
</html>
