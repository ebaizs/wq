let GIST_CONFIG ={GIST_ID:'',GITHUB_TOKEN:'',configLoaded:false};const builtInUsers = [{username:'qiyu',password:'8418',name:'ç®¡ç†å‘˜'},{username:'yonghu',password:'123',name:'é¡¹ç›®ç»ç†å¼ '},{username:'manager2',password:'manager2',name:'é¡¹ç›®ç»ç†æ'},{username:'supervisor1',password:'supervisor1',name:'ç›‘ç†ç‹'},{username:'supervisor2',password:'supervisor2',name:'ç›‘ç†èµµ'},{username:'designer1',password:'designer1',name:'è®¾è®¡å¸ˆåˆ˜'},{username:'accountant1',password:'accountant1',name:'è´¢åŠ¡é™ˆ'},{username:'worker1',password:'worker1',name:'å·¥äººä»£è¡¨æ¨'}];let currentUser = null;let currentSiteId = null;let sites = [];let changeLog = [];let isSyncing = false;function isAdmin(){return currentUser && currentUser.username === 'qiyu'}function canDelete(){return isAdmin()}function canEditTime(){return isAdmin()}function canEditStatus(){return isAdmin()}function canEditQuote(){return isAdmin()}function canClearLog(){return isAdmin()}function canAdd(){return currentUser !== null}function canEditWorkerRating(){return currentUser !== null}function canEditWorkerTime(){return currentUser !== null}function canEditNote(){return currentUser !== null}async function loadGithubConfig(){if(GIST_CONFIG.configLoaded)return true;const savedConfig = localStorage.getItem('github_config');if(savedConfig){try{const config = JSON.parse(savedConfig);GIST_CONFIG.GIST_ID = config.GIST_ID || '';GIST_CONFIG.GITHUB_TOKEN = config.GITHUB_TOKEN || '';GIST_CONFIG.configLoaded = true;if(GIST_CONFIG.GIST_ID && GIST_CONFIG.GITHUB_TOKEN){console.log('ä»localStorageåŠ è½½GitHubé…ç½®æˆåŠŸ');return true}}catch(e){console.warn('è§£æä¿å­˜çš„é…ç½®å¤±è´¥:',e)}}return await promptForConfigFile()}async function promptForConfigFile(){return new Promise((resolve)=>{const modal = document.createElement('div');modal.style.cssText = ` position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;backdrop-filter:blur(5px);`;modal.innerHTML = ` <div style="\u0062\u0061\u0063\u006b\u0067\u0072\u006f\u0075\u006e\u0064\u003a\u0077\u0068\u0069\u0074\u0065\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0033\u0030\u0070\u0078\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0031\u0035\u0070\u0078\u003b\u006d\u0061\u0078\u002d\u0077\u0069\u0064\u0074\u0068\u003a\u0035\u0030\u0030\u0070\u0078\u003b\u0077\u0069\u0064\u0074\u0068\u003a\u0039\u0030\u0025\u003b"> <h2 style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0032\u0030\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0033\u0033\u0033\u003b">é¦–æ¬¡ä½¿ç”¨é…ç½®</h2> <p style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0032\u0030\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0036\u003b"> è¿™æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨GitHubåŒæ­¥åŠŸèƒ½ï¼Œè¯·åŠ è½½åŒ…å«GitHubå¯†é’¥çš„é…ç½®æ–‡ä»¶ã€‚ </p> <p style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0032\u0030\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0036\u003b\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0034\u0070\u0078\u003b"> è¯·é€‰æ‹©åŒ…å«ä»¥ä¸‹å†…å®¹çš„TXTæ–‡ä»¶ï¼š<br> GIST_ID=ä½ çš„Gist_ID<br> GITHUB_TOKEN=ä½ çš„GitHub_Token </p> <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0032\u0030\u0070\u0078\u003b"> <label style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u0062\u006c\u006f\u0063\u006b\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0038\u0070\u0078\u003b\u0066\u006f\u006e\u0074\u002d\u0077\u0065\u0069\u0067\u0068\u0074\u003a\u0062\u006f\u006c\u0064\u003b"> é€‰æ‹©é…ç½®æ–‡ä»¶ï¼š </label> <input type="\u0066\u0069\u006c\u0065" id="\u0063\u006f\u006e\u0066\u0069\u0067\u0046\u0069\u006c\u0065\u0049\u006e\u0070\u0075\u0074" accept="\u002e\u0074\u0078\u0074" style="\u0077\u0069\u0064\u0074\u0068\u003a\u0031\u0030\u0030\u0025\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u0032\u0070\u0078\u0020\u0064\u0061\u0073\u0068\u0065\u0064\u0020\u0023\u0064\u0064\u0064\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0035\u0070\u0078\u003b"> </div> <div style="\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0072\u0069\u0067\u0068\u0074\u003b"> <button id="\u006d\u0061\u006e\u0075\u0061\u006c\u0043\u006f\u006e\u0066\u0069\u0067\u0042\u0074\u006e" style="\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u0020\u0032\u0030\u0070\u0078\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0072\u0069\u0067\u0068\u0074\u003a\u0031\u0030\u0070\u0078\u003b\u0062\u0061\u0063\u006b\u0067\u0072\u006f\u0075\u006e\u0064\u003a\u0023\u0066\u0038\u0066\u0039\u0066\u0061\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u0031\u0070\u0078\u0020\u0073\u006f\u006c\u0069\u0064\u0020\u0023\u0064\u0064\u0064\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0035\u0070\u0078\u003b\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> æ‰‹åŠ¨è¾“å…¥ </button> <button id="\u0073\u006b\u0069\u0070\u0043\u006f\u006e\u0066\u0069\u0067\u0042\u0074\u006e" style="\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u0020\u0032\u0030\u0070\u0078\u003b\u0062\u0061\u0063\u006b\u0067\u0072\u006f\u0075\u006e\u0064\u003a\u0023\u0036\u0063\u0037\u0035\u0037\u0064\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0077\u0068\u0069\u0074\u0065\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u006e\u006f\u006e\u0065\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0035\u0070\u0078\u003b\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> è·³è¿‡é…ç½® </button> </div> <div id="\u006d\u0061\u006e\u0075\u0061\u006c\u0043\u006f\u006e\u0066\u0069\u0067" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0035\u0070\u0078\u003b\u0062\u0061\u0063\u006b\u0067\u0072\u006f\u0075\u006e\u0064\u003a\u0023\u0066\u0038\u0066\u0039\u0066\u0061\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0035\u0070\u0078\u003b"> <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0031\u0030\u0070\u0078\u003b"> <label style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u0062\u006c\u006f\u0063\u006b\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0035\u0070\u0078\u003b">Gist IDï¼š</label> <input type="\u0074\u0065\u0078\u0074" id="\u006d\u0061\u006e\u0075\u0061\u006c\u0047\u0069\u0073\u0074\u0049\u0064" style="\u0077\u0069\u0064\u0074\u0068\u003a\u0031\u0030\u0030\u0025\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0038\u0070\u0078\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u0031\u0070\u0078\u0020\u0073\u006f\u006c\u0069\u0064\u0020\u0023\u0064\u0064\u0064\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0034\u0070\u0078\u003b" placeholder="\u4f8b\u5982\uff1a\u0030\u0039\u0037\u0066\u0038\u0061\u0064\u0062\u0062\u0033\u0037\u0039\u0030\u0066\u0033\u0061\u0039\u0035\u0062\u0061\u0035\u0038\u0036\u0061\u0030\u0038\u0036\u0037\u0036\u0039\u0039\u0062"> </div> <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0031\u0030\u0070\u0078\u003b"> <label style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u0062\u006c\u006f\u0063\u006b\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0035\u0070\u0078\u003b">GitHub Tokenï¼š</label> <input type="\u0074\u0065\u0078\u0074" id="\u006d\u0061\u006e\u0075\u0061\u006c\u0054\u006f\u006b\u0065\u006e" style="\u0077\u0069\u0064\u0074\u0068\u003a\u0031\u0030\u0030\u0025\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0038\u0070\u0078\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u0031\u0070\u0078\u0020\u0073\u006f\u006c\u0069\u0064\u0020\u0023\u0064\u0064\u0064\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0034\u0070\u0078\u003b" placeholder="\u4f8b\u5982\uff1a\u0067\u0068\u0070\u005f\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078\u0078"> </div> <button id="\u0073\u0061\u0076\u0065\u004d\u0061\u006e\u0075\u0061\u006c\u0043\u006f\u006e\u0066\u0069\u0067" style="\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0038\u0070\u0078\u0020\u0031\u0036\u0070\u0078\u003b\u0062\u0061\u0063\u006b\u0067\u0072\u006f\u0075\u006e\u0064\u003a\u0023\u0032\u0038\u0061\u0037\u0034\u0035\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0077\u0068\u0069\u0074\u0065\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u006e\u006f\u006e\u0065\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0034\u0070\u0078\u003b\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> ä¿å­˜é…ç½® </button> </div> <p id="\u0063\u006f\u006e\u0066\u0069\u0067\u0045\u0072\u0072\u006f\u0072" style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0064\u0063\u0033\u0035\u0034\u0035\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0031\u0030\u0070\u0078\u003b\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b"></p> </div> `;document.body.appendChild(modal);const fileInput = modal.querySelector('#configFileInput');const skipBtn = modal.querySelector('#skipConfigBtn');const manualBtn = modal.querySelector('#manualConfigBtn');const manualDiv = modal.querySelector('#manualConfig');const errorDiv = modal.querySelector('#configError');fileInput.addEventListener('change',async function(e){const file = e.target.files[0];if(!file)return;const reader = new FileReader();reader.onload = function(e){const content = e.target.result;const config = parseConfigFile(content);if(config.GIST_ID && config.GITHUB_TOKEN){GIST_CONFIG.GIST_ID = config.GIST_ID;GIST_CONFIG.GITHUB_TOKEN = config.GITHUB_TOKEN;GIST_CONFIG.configLoaded = true;localStorage.setItem('github_config',JSON.stringify({GIST_ID:config.GIST_ID,GITHUB_TOKEN:config.GITHUB_TOKEN,lastUpdate:new Date().toISOString()}));modal.remove();showSimpleToast('é…ç½®åŠ è½½æˆåŠŸï¼');resolve(true)}else{errorDiv.textContent = 'é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿åŒ…å«GIST_IDå’ŒGITHUB_TOKEN';errorDiv.style.display = 'block'}};reader.readAsText(file)});skipBtn.addEventListener('click',function(){GIST_CONFIG.configLoaded = false;modal.remove();showSimpleToast('å·²è·³è¿‡é…ç½®ï¼ŒGitHubåŒæ­¥åŠŸèƒ½ä¸å¯ç”¨','warning');resolve(false)});manualBtn.addEventListener('click',function(){manualDiv.style.display = 'block';manualBtn.style.display = 'none'});modal.querySelector('#saveManualConfig').addEventListener('click',function(){const gistId = modal.querySelector('#manualGistId').value.trim();const token = modal.querySelector('#manualToken').value.trim();if(!gistId || !token){errorDiv.textContent = 'è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯';errorDiv.style.display = 'block';return}GIST_CONFIG.GIST_ID = gistId;GIST_CONFIG.GITHUB_TOKEN = token;GIST_CONFIG.configLoaded = true;localStorage.setItem('github_config',JSON.stringify({GIST_ID:gistId,GITHUB_TOKEN:token,lastUpdate:new Date().toISOString()}));modal.remove();showSimpleToast('é…ç½®ä¿å­˜æˆåŠŸï¼');resolve(true)})})}function parseConfigFile(content){const config ={GIST_ID:'',GITHUB_TOKEN:''};const lines = content.split('\n');lines.forEach(line =>{const trimmed = line.trim();if(trimmed.startsWith('GIST_ID=')){config.GIST_ID = trimmed.substring(8).trim()}else if(trimmed.startsWith('GITHUB_TOKEN=')){config.GITHUB_TOKEN = trimmed.substring(13).trim()}});return config}function manageGithubConfig(){localStorage.removeItem('github_config');GIST_CONFIG ={GIST_ID:'',GITHUB_TOKEN:'',configLoaded:false};showSimpleToast('é…ç½®å·²é‡ç½®ï¼Œä¸‹æ¬¡åŒæ­¥æ—¶å°†é‡æ–°é…ç½®')}function renderTodoList(site){const list = document.getElementById('todoList');if(!site.todos || site.todos.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— å¾…åŠäº‹é¡¹</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th>äº‹é¡¹åç§°</th>' + '<th class="\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0063\u006f\u006c">çŠ¶æ€</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.todos.forEach(todo =>{let statusCell = '';if(canEditStatus()){statusCell = `<td> <select class="\u0074\u006f\u0064\u006f\u002d\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0073\u0065\u006c\u0065\u0063\u0074" data-id="\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0064\u007d" onchange="\u0075\u0070\u0064\u0061\u0074\u0065\u0054\u006f\u0064\u006f\u0053\u0074\u0061\u0074\u0075\u0073\u0028\u0027\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u0029"> <option value="\u0070\u0065\u006e\u0064\u0069\u006e\u0067" ${todo.status === 'pending' ? 'selected':''}>å¾…åŠ</option> <option value="\u0069\u006e\u002d\u0070\u0072\u006f\u0067\u0072\u0065\u0073\u0073" ${todo.status === 'in-progress' ? 'selected':''}>è¿›è¡Œä¸­</option> <option value="\u0063\u006f\u006d\u0070\u006c\u0065\u0074\u0065\u0064" ${todo.status === 'completed' ? 'selected':''}>å·²å®Œæˆ</option> </select> </td>`}else{const statusText ={'pending':'å¾…åŠ','in-progress':'è¿›è¡Œä¸­','completed':'å·²å®Œæˆ'};const statusColor ={'pending':'#ff9800','in-progress':'#2196f3','completed':'#4caf50'};statusCell = `<td><span style="\u0063\u006f\u006c\u006f\u0072\u003a\u0024\u007b\u0073\u0074\u0061\u0074\u0075\u0073\u0043\u006f\u006c\u006f\u0072\u005b\u0074\u006f\u0064\u006f\u002e\u0073\u0074\u0061\u0074\u0075\u0073\u005d\u007d">${statusText[todo.status]}</span></td>`}html += `<tr> <td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0074\u0065\u006d\u007d">${todo.item}</td> ${statusCell}<td>${formatDate(todo.time)}</td> <td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${todo.operator}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0074\u006f\u0064\u006f\u0027\u0029">åˆ é™¤</button>`:''}</div> </td> </tr>`;if(todo.note && todo.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0035" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0074\u006f\u0064\u006f\u0027\u002c\u0027\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${todo.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0074\u006f\u0064\u006f" data-id="\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${todo.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function renderExpenseList(site){const list = document.getElementById('expenseList');if(!site.expenses || site.expenses.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— æ”¯å‡ºè®°å½•</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th>é¡¹ç›®åç§°</th>' + '<th class="\u0075\u006e\u0069\u0074\u002d\u0063\u006f\u006c">å•ä½</th>' + '<th>é‡‘é¢</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.expenses.forEach(expense =>{let timeCell = '';if(canEditTime()){timeCell = `<td onclick="\u0065\u0064\u0069\u0074\u0054\u0069\u006d\u0065\u0028\u0074\u0068\u0069\u0073\u002c\u0027\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0064\u007d\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(expense.time)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0074\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0074\u0069\u006d\u0065\u0027\u0029"> </td>`}else{timeCell = `<td>${formatDate(expense.time)}</td>`}html += `<tr> <td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0074\u0065\u006d\u007d">${expense.item}</td> <td class="\u0075\u006e\u0069\u0074\u002d\u0063\u006f\u006c">${expense.unit || 'é¡¹'}</td> <td>Â¥${expense.amount.toFixed(2)}</td> ${timeCell}<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${expense.operator || '-'}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u0027\u0029">åˆ é™¤</button>`:''}</div> </td> </tr>`;if(expense.note && expense.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u0027\u002c\u0027\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${expense.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0065\u0078\u0070\u0065\u006e\u0073\u0065" data-id="\u0024\u007b\u0065\u0078\u0070\u0065\u006e\u0073\u0065\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${expense.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function renderRequirementList(site){const list = document.getElementById('requirementList');if(!site.requirements || site.requirements.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— å®¢æˆ·è¦æ±‚</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th style="\u006d\u0061\u0078\u002d\u0077\u0069\u0064\u0074\u0068\u003a\u0038\u0030\u0070\u0078\u003b">è¦æ±‚å†…å®¹</th>' + '<th style="\u0077\u0069\u0064\u0074\u0068\u003a\u0036\u0030\u0070\u0078\u003b">ç±»å‹</th>' + '<th class="\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0063\u006f\u006c">çŠ¶æ€</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.requirements.forEach(req =>{const typeText = req.type === 'need' ? 'éœ€è¦':'æ’é™¤';const typeColor = req.type === 'need' ? '#4caf50':'#ff6b6b';let statusCell = '';if(canEditStatus()){statusCell = `<td> <select class="\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u006d\u0065\u006e\u0074\u002d\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0073\u0065\u006c\u0065\u0063\u0074" data-id="\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d" onchange="\u0075\u0070\u0064\u0061\u0074\u0065\u0052\u0065\u0071\u0075\u0069\u0072\u0065\u006d\u0065\u006e\u0074\u0053\u0074\u0061\u0074\u0075\u0073\u0028\u0027\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u0029"> <option value="\u0070\u0065\u006e\u0064\u0069\u006e\u0067" ${req.status === 'pending' ? 'selected':''}>å¾…å®Œæˆ</option> <option value="\u0069\u006e\u002d\u0070\u0072\u006f\u0067\u0072\u0065\u0073\u0073" ${req.status === 'in-progress' ? 'selected':''}>è¿›è¡Œä¸­</option> <option value="\u0063\u006f\u006d\u0070\u006c\u0065\u0074\u0065\u0064" ${req.status === 'completed' ? 'selected':''}>å·²å®Œæˆ</option> </select> </td>`}else{const statusText ={'pending':'å¾…å®Œæˆ','in-progress':'è¿›è¡Œä¸­','completed':'å·²å®Œæˆ'};const statusColor ={'pending':'#666','in-progress':'#ff9800','completed':'#4caf50'};statusCell = `<td><span style="\u0063\u006f\u006c\u006f\u0072\u003a\u0024\u007b\u0073\u0074\u0061\u0074\u0075\u0073\u0043\u006f\u006c\u006f\u0072\u005b\u0072\u0065\u0071\u002e\u0073\u0074\u0061\u0074\u0075\u0073\u005d\u007d">${statusText[req.status]}</span></td>`}let timeCell = '';if(canEditTime()){timeCell = `<td onclick="\u0065\u0064\u0069\u0074\u0054\u0069\u006d\u0065\u0028\u0074\u0068\u0069\u0073\u002c\u0027\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(req.time)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0072\u0065\u0071\u002e\u0074\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0074\u0069\u006d\u0065\u0027\u0029"> </td>`}else{timeCell = `<td>${formatDate(req.time)}</td>`}html += `<tr> <td class="\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0074\u0065\u0078\u0074\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0072\u0065\u0071\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d">${req.content}</td> <td style="\u0063\u006f\u006c\u006f\u0072\u003a\u0024\u007b\u0074\u0079\u0070\u0065\u0043\u006f\u006c\u006f\u0072\u007d\u003b\u0066\u006f\u006e\u0074\u002d\u0077\u0065\u0069\u0067\u0068\u0074\u003a\u0035\u0030\u0030\u003b">${typeText}</td> ${statusCell}${timeCell}<td class="\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0074\u0065\u0078\u0074\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${req.operator}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u006d\u0065\u006e\u0074\u0027\u0029">åˆ é™¤</button>`:''}</div> </td> </tr>`;if(req.note && req.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u006d\u0065\u006e\u0074\u0027\u002c\u0027\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${req.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0072\u0065\u0071\u0075\u0069\u0072\u0065\u006d\u0065\u006e\u0074" data-id="\u0024\u007b\u0072\u0065\u0071\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${req.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function renderRepairList(site){const list = document.getElementById('repairList');if(!site.repairs || site.repairs.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— ç»´ä¿®é¡¹</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th>å›¾ç‰‡ä¿¡æ¯</th>' + '<th class="\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0063\u006f\u006c">çŠ¶æ€</th>' + '<th>ç»´ä¿®å†…å®¹</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.repairs.forEach(repair =>{let photoHtml = '';if(!repair.photo){photoHtml = `<div class="\u0070\u0068\u006f\u0074\u006f\u002d\u0070\u006c\u0061\u0063\u0065\u0068\u006f\u006c\u0064\u0065\u0072"> <div>ğŸ“·</div> <div>æ— å›¾ç‰‡</div> <button onclick="\u0061\u0064\u0064\u0050\u0068\u006f\u0074\u006f\u0054\u006f\u0052\u0065\u0070\u0061\u0069\u0072\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u0029">æ·»åŠ å›¾ç‰‡</button> <input type="\u0066\u0069\u006c\u0065" accept="\u0069\u006d\u0061\u0067\u0065\u002f\u002a" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" id="\u0061\u0064\u0064\u0050\u0068\u006f\u0074\u006f\u0049\u006e\u0070\u0075\u0074\u005f\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d" onchange="\u0075\u0070\u006c\u006f\u0061\u0064\u0050\u0068\u006f\u0074\u006f\u0046\u006f\u0072\u0052\u0065\u0070\u0061\u0069\u0072\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029"> </div>`}else if(repair.photo.startsWith('[PHOTO:')){const fileName = repair.photo.match(/\[PHOTO:(.+?)\]/)[1];photoHtml = `<div class="\u0070\u0068\u006f\u0074\u006f\u002d\u006d\u0069\u0073\u0073\u0069\u006e\u0067"> <div>âš ï¸</div> <div>å›¾ç‰‡ç¼ºå¤±<br><small>éœ€è¦å•ç‹¬åŠ è½½</small></div> <button onclick="\u0074\u0072\u0079\u004c\u006f\u0061\u0064\u004d\u0069\u0073\u0073\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u007d\u0027\u0029">åŠ è½½å›¾ç‰‡</button> </div>`}else{photoHtml = `<div class="\u0070\u0068\u006f\u0074\u006f\u002d\u0063\u006f\u006e\u0074\u0061\u0069\u006e\u0065\u0072"> <img src="\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u007d" onclick="\u0076\u0069\u0065\u0077\u0049\u006d\u0061\u0067\u0065\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u007d\u0027\u0029"> <button onclick="\u0063\u0068\u0061\u006e\u0067\u0065\u0052\u0065\u0070\u0061\u0069\u0072\u0050\u0068\u006f\u0074\u006f\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029">â†»</button> <input type="\u0066\u0069\u006c\u0065" accept="\u0069\u006d\u0061\u0067\u0065\u002f\u002a" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onchange="\u0075\u0070\u006c\u006f\u0061\u0064\u004e\u0065\u0077\u0052\u0065\u0070\u0061\u0069\u0072\u0050\u0068\u006f\u0074\u006f\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" class="\u0072\u0065\u0070\u0061\u0069\u0072\u002d\u0070\u0068\u006f\u0074\u006f\u002d\u0069\u006e\u0070\u0075\u0074"> </div>`}let statusCell = '';if(canEditStatus()){statusCell = `<td> <select class="\u0072\u0065\u0070\u0061\u0069\u0072\u002d\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0073\u0065\u006c\u0065\u0063\u0074" data-id="\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d" onchange="\u0075\u0070\u0064\u0061\u0074\u0065\u0052\u0065\u0070\u0061\u0069\u0072\u0053\u0074\u0061\u0074\u0075\u0073\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u0029"> <option value="\u0070\u0065\u006e\u0064\u0069\u006e\u0067" ${repair.status === 'pending' ? 'selected':''}>å¾…ç»´ä¿®</option> <option value="\u0063\u006f\u006d\u0070\u006c\u0065\u0074\u0065\u0064" ${repair.status === 'completed' ? 'selected':''}>å·²å®Œæˆ</option> </select> </td>`}else{statusCell = `<td><span style="\u0063\u006f\u006c\u006f\u0072\u003a\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0073\u0074\u0061\u0074\u0075\u0073\u0020\u003d\u003d\u003d\u0020\u0027\u0063\u006f\u006d\u0070\u006c\u0065\u0074\u0065\u0064\u0027\u0020\u003f\u0020\u0027\u0023\u0034\u0063\u0061\u0066\u0035\u0030\u0027\u003a\u0027\u0023\u0066\u0066\u0039\u0038\u0030\u0030\u0027\u007d">${repair.status === 'completed' ? 'å·²å®Œæˆ':'å¾…ç»´ä¿®'}</span></td>`}let timeCell = '';if(canEditTime()){timeCell = `<td onclick="\u0065\u0064\u0069\u0074\u0054\u0069\u006d\u0065\u0028\u0074\u0068\u0069\u0073\u002c\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(repair.time)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0074\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0074\u0069\u006d\u0065\u0027\u0029"> </td>`}else{timeCell = `<td>${formatDate(repair.time)}</td>`}const completeButton = repair.status === 'pending' ? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0062\u0074\u006e\u002d\u0073\u0075\u0063\u0063\u0065\u0073\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0063\u006f\u006d\u0070\u006c\u0065\u0074\u0065\u0052\u0065\u0070\u0061\u0069\u0072\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u0029">å®Œæˆ</button>`:'';html += `<tr> <td>${photoHtml}</td> ${statusCell}<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d">${repair.content}</td> ${timeCell}<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${repair.operator}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0072\u0065\u0070\u0061\u0069\u0072\u0027\u0029">åˆ é™¤</button>`:''}${completeButton}</div> </td> </tr>`;if(repair.note && repair.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0072\u0065\u0070\u0061\u0069\u0072\u0027\u002c\u0027\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${repair.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0072\u0065\u0070\u0061\u0069\u0072" data-id="\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${repair.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function addPhotoToRepair(repairId){const input = document.getElementById(`addPhotoInput_${repairId}`);if(input)input.click()}function uploadPhotoForRepair(repairId,fileInput){const file = fileInput.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');return}resizeImage(file,500,function(resizedDataUrl){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const repair = site.repairs.find(r => r.id === repairId);if(repair){repair.photo = resizedDataUrl;repair.photoName = file.name;saveData();renderRepairList(site);addChangeLog('æ·»åŠ ç»´ä¿®å›¾ç‰‡',`ä¸ºç»´ä¿®é¡¹"\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d"æ·»åŠ äº†å›¾ç‰‡`);alert('å›¾ç‰‡æ·»åŠ æˆåŠŸï¼')}})}function renderWorkerList(site){const list = document.getElementById('workerList');if(!site.workers || site.workers.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— å·¥äººè®°å½•</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th>æ–½å·¥é¡¹ç›®</th>' + '<th>å§“å</th>' + '<th>å¼€å§‹æ—¶é—´</th>' + '<th>ç»“æŸæ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.workers.forEach(worker =>{const startTimeCell = canEditWorkerTime()? `<td onclick="\u0065\u0064\u0069\u0074\u0057\u006f\u0072\u006b\u0065\u0072\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002c\u0027\u0073\u0074\u0061\u0072\u0074\u0054\u0069\u006d\u0065\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(worker.startTime)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0073\u0074\u0061\u0072\u0074\u0054\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0057\u006f\u0072\u006b\u0065\u0072\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0073\u0074\u0061\u0072\u0074\u0054\u0069\u006d\u0065\u0027\u0029"> </td>`:`<td>${formatDate(worker.startTime)}</td>`;const endTimeCell = canEditWorkerTime()? `<td onclick="\u0065\u0064\u0069\u0074\u0057\u006f\u0072\u006b\u0065\u0072\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002c\u0027\u0065\u006e\u0064\u0054\u0069\u006d\u0065\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(worker.endTime)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0065\u006e\u0064\u0054\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0057\u006f\u0072\u006b\u0065\u0072\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0065\u006e\u0064\u0054\u0069\u006d\u0065\u0027\u0029"> </td>`:`<td>${worker.endTime ? formatDate(worker.endTime):'æœªç»“æŸ'}</td>`;html += `<tr> <td>${worker.type}</td> <td>${worker.name}</td> ${startTimeCell}${endTimeCell}<td>${worker.operator}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0077\u006f\u0072\u006b\u0065\u0072\u0027\u0029">åˆ é™¤</button>`:''}</div> </td> </tr>`;if(worker.note && worker.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0077\u006f\u0072\u006b\u0065\u0072\u0027\u002c\u0027\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">å¤‡æ³¨ï¼š${worker.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0077\u006f\u0072\u006b\u0065\u0072" data-id="\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${worker.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function renderAddRemoveList(site){const list = document.getElementById('addRemoveList');if(!site.addRemoveItems || site.addRemoveItems.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— å¢å‡é¡¹</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th>é¡¹ç›®åç§°</th>' + '<th>ç±»å‹</th>' + '<th>é‡‘é¢</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.addRemoveItems.forEach(item =>{let timeCell = '';if(canEditTime()){timeCell = `<td onclick="\u0065\u0064\u0069\u0074\u0054\u0069\u006d\u0065\u0028\u0074\u0068\u0069\u0073\u002c\u0027\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0064\u007d\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(item.time)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0069\u0074\u0065\u006d\u002e\u0074\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0074\u0069\u006d\u0065\u0027\u0029"> </td>`}else{timeCell = `<td>${formatDate(item.time)}</td>`}html += `<tr> <td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0074\u0065\u006d\u007d">${item.item}</td> <td><span style="\u0063\u006f\u006c\u006f\u0072\u003a\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0074\u0079\u0070\u0065\u0020\u003d\u003d\u003d\u0020\u0027\u0061\u0064\u0064\u0027\u0020\u003f\u0020\u0027\u0023\u0034\u0063\u0061\u0066\u0035\u0030\u0027\u003a\u0027\u0023\u0066\u0066\u0036\u0062\u0036\u0062\u0027\u007d">${item.type === 'add' ? 'å¢åŠ ':'å‡å°‘'}</span></td> <td>${item.type === 'add' ? '+':'-'}Â¥${item.amount.toFixed(2)}</td> ${timeCell}<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${item.operator || '-'}</td> <td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0061\u0064\u0064\u0052\u0065\u006d\u006f\u0076\u0065\u0027\u0029">åˆ é™¤</button>`:''}</div> </td> </tr>`;if(item.note && item.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0061\u0064\u0064\u0052\u0065\u006d\u006f\u0076\u0065\u0027\u002c\u0027\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${item.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0061\u0064\u0064\u0052\u0065\u006d\u006f\u0076\u0065" data-id="\u0024\u007b\u0069\u0074\u0065\u006d\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${item.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function renderDrawingList(site){const list = document.getElementById('drawingList');if(!site.drawings || site.drawings.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— å›¾çº¸</p>';return}let html = '<table class="\u0064\u0061\u0074\u0061\u002d\u0074\u0061\u0062\u006c\u0065"><thead><tr>' + '<th style="\u006d\u0069\u006e\u002d\u0068\u0065\u0069\u0067\u0068\u0074\u003a\u0038\u0030\u0070\u0078\u003b\u0077\u0069\u0064\u0074\u0068\u003a\u0031\u0032\u0030\u0070\u0078\u003b">æ–‡ä»¶ä¿¡æ¯</th>' + '<th>å›¾çº¸ç±»å‹</th>' + '<th>æ–‡ä»¶å</th>' + '<th>æ—¶é—´</th>' + '<th>æ“ä½œäºº</th>' + '<th class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0063\u006f\u006c">æ“ä½œ</th>' + '</tr></thead><tbody>';site.drawings.forEach(drawing =>{let fileHtml = '';if(drawing.file){if(drawing.file.startsWith('[FILE:')){const fileName = drawing.file.match(/\[FILE:(.+?)\]/)[1];fileHtml = `<div class="\u0066\u0069\u006c\u0065\u002d\u006d\u0069\u0073\u0073\u0069\u006e\u0067"> <div>ğŸ“„</div> <div>æ–‡ä»¶ç¼ºå¤±<br><small>éœ€å•ç‹¬åŠ è½½</small></div> <button onclick="\u0074\u0072\u0079\u004c\u006f\u0061\u0064\u004d\u0069\u0073\u0073\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u007d\u0027\u0029">åŠ è½½æ–‡ä»¶</button> </div>`}else{if(drawing.fileType && drawing.fileType.startsWith('image/')){fileHtml = `<div class="\u0066\u0069\u006c\u0065\u002d\u0063\u006f\u006e\u0074\u0061\u0069\u006e\u0065\u0072"> <img src="\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u007d" onclick="\u0076\u0069\u0065\u0077\u0049\u006d\u0061\u0067\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u007d\u0027\u0029"> <button class="\u0069\u006d\u0061\u0067\u0065\u002d\u0063\u0068\u0061\u006e\u0067\u0065\u002d\u0062\u0074\u006e" onclick="\u0063\u0068\u0061\u006e\u0067\u0065\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u66f4\u6362\u6587\u4ef6">â†»</button> <input type="\u0066\u0069\u006c\u0065" accept="\u002e\u0070\u0064\u0066\u002c\u002e\u006a\u0070\u0067\u002c\u002e\u006a\u0070\u0065\u0067\u002c\u002e\u0070\u006e\u0067\u002c\u002e\u0078\u006c\u0073\u002c\u002e\u0078\u006c\u0073\u0078\u002c\u002e\u0064\u006f\u0063\u002c\u002e\u0064\u006f\u0063\u0078\u002c\u002e\u0063\u0073\u0076" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onchange="\u0075\u0070\u006c\u006f\u0061\u0064\u004e\u0065\u0077\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" class="\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002d\u0066\u0069\u006c\u0065\u002d\u0069\u006e\u0070\u0075\u0074"> </div>`}else{const fileIcon = getFileIcon(drawing.fileType);const fileNameDisplay = drawing.fileName || 'æœªå‘½åæ–‡ä»¶';const shortName = fileNameDisplay.length > 12 ? fileNameDisplay.substring(0,12)+ '...':fileNameDisplay;fileHtml = `<div class="\u0066\u0069\u006c\u0065\u002d\u0063\u006f\u006e\u0074\u0061\u0069\u006e\u0065\u0072\u0020\u006e\u006f\u006e\u002d\u0069\u006d\u0061\u0067\u0065"> <div>${fileIcon}</div> <div>${shortName}</div> <button class="\u0069\u006d\u0061\u0067\u0065\u002d\u0063\u0068\u0061\u006e\u0067\u0065\u002d\u0062\u0074\u006e" onclick="\u0063\u0068\u0061\u006e\u0067\u0065\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u66f4\u6362\u6587\u4ef6">â†»</button> <input type="\u0066\u0069\u006c\u0065" accept="\u002e\u0070\u0064\u0066\u002c\u002e\u006a\u0070\u0067\u002c\u002e\u006a\u0070\u0065\u0067\u002c\u002e\u0070\u006e\u0067\u002c\u002e\u0078\u006c\u0073\u002c\u002e\u0078\u006c\u0073\u0078\u002c\u002e\u0064\u006f\u0063\u002c\u002e\u0064\u006f\u0063\u0078\u002c\u002e\u0063\u0073\u0076" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onchange="\u0075\u0070\u006c\u006f\u0061\u0064\u004e\u0065\u0077\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" class="\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002d\u0066\u0069\u006c\u0065\u002d\u0069\u006e\u0070\u0075\u0074"> </div>`}}}else{fileHtml = `<div class="\u0066\u0069\u006c\u0065\u002d\u0070\u006c\u0061\u0063\u0065\u0068\u006f\u006c\u0064\u0065\u0072"> <div>ğŸ“„</div> <div>æ— æ–‡ä»¶</div> <button onclick="\u0061\u0064\u0064\u0046\u0069\u006c\u0065\u0054\u006f\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u0029">æ·»åŠ æ–‡ä»¶</button> <input type="\u0066\u0069\u006c\u0065" accept="\u002e\u0070\u0064\u0066\u002c\u002e\u006a\u0070\u0067\u002c\u002e\u006a\u0070\u0065\u0067\u002c\u002e\u0070\u006e\u0067\u002c\u002e\u0078\u006c\u0073\u002c\u002e\u0078\u006c\u0073\u0078\u002c\u002e\u0064\u006f\u0063\u002c\u002e\u0064\u006f\u0063\u0078\u002c\u002e\u0063\u0073\u0076" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" id="\u0061\u0064\u0064\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0046\u0069\u006c\u0065\u005f\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d" onchange="\u0075\u0070\u006c\u006f\u0061\u0064\u0046\u0069\u006c\u0065\u0046\u006f\u0072\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029"> </div>`}let timeCell = '';if(canEditTime()){timeCell = `<td onclick="\u0065\u0064\u0069\u0074\u0054\u0069\u006d\u0065\u0028\u0074\u0068\u0069\u0073\u002c\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u0029" title="\u70b9\u51fb\u7f16\u8f91\u65e5\u671f" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <span class="\u0064\u0061\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079">${formatDate(drawing.time)}</span> <input type="\u0064\u0061\u0074\u0065" class="\u0064\u0061\u0074\u0065\u002d\u0065\u0064\u0069\u0074" value="\u0024\u007b\u0066\u006f\u0072\u006d\u0061\u0074\u0044\u0061\u0074\u0065\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0074\u0069\u006d\u0065\u0029\u007d" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" onblur="\u0073\u0061\u0076\u0065\u0054\u0069\u006d\u0065\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u002e\u0076\u0061\u006c\u0075\u0065\u002c\u0027\u0074\u0069\u006d\u0065\u0027\u0029"> </td>`}else{timeCell = `<td>${formatDate(drawing.time)}</td>`}html += `<tr style="\u006d\u0069\u006e\u002d\u0068\u0065\u0069\u0067\u0068\u0074\u003a\u0038\u0030\u0070\u0078\u003b">`;html += `<td>${fileHtml}</td>`;html += `<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0067\u0065\u0074\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0054\u0079\u0070\u0065\u0054\u0065\u0078\u0074\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0074\u0079\u0070\u0065\u0029\u007d">${getDrawingTypeText(drawing.type)}</td>`;html += `<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065" title="\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0027\u672a\u547d\u540d\u0027\u007d">${drawing.fileName || 'æœªå‘½å'}</td>`;html += `${timeCell}`;html += `<td class="\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">${drawing.operator}</td>`;html += `<td> <div class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0073\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074"> ${canDelete()? `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0027\u0029">åˆ é™¤</button>`:''}<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0062\u0074\u006e\u002d\u0070\u0072\u0069\u006d\u0061\u0072\u0079\u0020\u0063\u006f\u006d\u0070\u0061\u0063\u0074\u002d\u0062\u0074\u006e" onclick="\u0064\u006f\u0077\u006e\u006c\u006f\u0061\u0064\u0044\u0072\u0061\u0077\u0069\u006e\u0067\u0028\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u0029">ä¸‹è½½</button> </div> </td>`;html += `</tr>`;if(drawing.note && drawing.note.trim()){html += `<tr class="\u006e\u006f\u0074\u0065\u002d\u0072\u006f\u0077"> <td colspan="\u0036" class="\u006e\u006f\u0074\u0065\u002d\u0063\u0065\u006c\u006c" onclick="\u0065\u0064\u0069\u0074\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0027\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0027\u002c\u0027\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d\u0027\u002c\u0074\u0068\u0069\u0073\u0029" title="\u70b9\u51fb\u7f16\u8f91\u5907\u6ce8" style="\u0063\u0075\u0072\u0073\u006f\u0072\u003a\u0070\u006f\u0069\u006e\u0074\u0065\u0072\u003b"> <div class="\u006e\u006f\u0074\u0065\u002d\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u0020\u006d\u0075\u006c\u0074\u0069\u002d\u006c\u0069\u006e\u0065">å¤‡æ³¨ï¼š${drawing.note}</div> <textarea class="\u006e\u006f\u0074\u0065\u002d\u0065\u0064\u0069\u0074\u002d\u0061\u0075\u0074\u006f" style="\u0064\u0069\u0073\u0070\u006c\u0061\u0079\u003a\u006e\u006f\u006e\u0065\u003b" data-type="\u0064\u0072\u0061\u0077\u0069\u006e\u0067" data-id="\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0069\u0064\u007d" onblur="\u0073\u0061\u0076\u0065\u004e\u006f\u0074\u0065\u0041\u0075\u0074\u006f\u0053\u0061\u0076\u0065\u0028\u0065\u0076\u0065\u006e\u0074\u0029" onkeydown="\u0068\u0061\u006e\u0064\u006c\u0065\u004e\u006f\u0074\u0065\u004b\u0065\u0079\u0064\u006f\u0077\u006e\u0028\u0065\u0076\u0065\u006e\u0074\u0029">${drawing.note}</textarea> </td> </tr>`}});html += '</tbody></table>';list.innerHTML = html}function addFileToDrawing(drawingId){const input = document.getElementById(`addDrawingFile_${drawingId}`);if(input)input.click()}function uploadFileForDrawing(drawingId,fileInput){const file = fileInput.files[0];if(!file)return;const site = sites.find(s => s.id === currentSiteId);if(!site)return;const drawing = site.drawings.find(d => d.id === drawingId);if(!drawing)return;if(file.type.startsWith('image/')){resizeImage(file,500,function(resizedDataUrl){drawing.file = resizedDataUrl;drawing.fileName = file.name;drawing.fileType = file.type;drawing.fileSize = file.size;saveData();renderDrawingList(site);addChangeLog('æ·»åŠ å›¾çº¸æ–‡ä»¶',`ä¸ºå›¾çº¸"\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0027\u672a\u547d\u540d\u0027\u007d"æ·»åŠ äº†æ–‡ä»¶`);alert('æ–‡ä»¶æ·»åŠ æˆåŠŸï¼')})}else{const reader = new FileReader();reader.onload = function(e){drawing.file = e.target.result;drawing.fileName = file.name;drawing.fileType = file.type;drawing.fileSize = file.size;saveData();renderDrawingList(site);addChangeLog('æ·»åŠ å›¾çº¸æ–‡ä»¶',`ä¸ºå›¾çº¸"\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0027\u672a\u547d\u540d\u0027\u007d"æ·»åŠ äº†æ–‡ä»¶`);alert('æ–‡ä»¶æ·»åŠ æˆåŠŸï¼')};reader.readAsDataURL(file)}}function renderExperienceList(site){const list = document.getElementById('experienceList');if(!site.experiences || site.experiences.length === 0){list.innerHTML = '<p style="\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0039\u0039\u0039\u003b\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0032\u0030\u0070\u0078\u003b">æš‚æ— ç»éªŒæ€»ç»“</p>';return}list.innerHTML = '';site.experiences.forEach(exp =>{const expItem = document.createElement('div');expItem.className = 'experience-item';const contentDiv = document.createElement('div');contentDiv.style.flex = '1';contentDiv.style.minWidth = '0';const headerDiv = document.createElement('div');headerDiv.className = 'experience-header';headerDiv.innerHTML = ` <span>${exp.operator}- ç»éªŒæ€»ç»“</span> <span class="\u0065\u0078\u0070\u0065\u0072\u0069\u0065\u006e\u0063\u0065\u002d\u0074\u0069\u006d\u0065">${exp.time}</span> `;const contentText = document.createElement('div');contentText.className = 'experience-content';contentText.textContent = exp.content;contentText.title = exp.content;contentDiv.appendChild(headerDiv);contentDiv.appendChild(contentText);const actionDiv = document.createElement('div');if(canDelete()){actionDiv.innerHTML = `<button class="\u0061\u0063\u0074\u0069\u006f\u006e\u002d\u0062\u0074\u006e\u0020\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e" onclick="\u0064\u0065\u006c\u0065\u0074\u0065\u0049\u0074\u0065\u006d\u0028\u0027\u0024\u007b\u0065\u0078\u0070\u002e\u0069\u0064\u007d\u0027\u002c\u0027\u0065\u0078\u0070\u0065\u0072\u0069\u0065\u006e\u0063\u0065\u0027\u0029">åˆ é™¤</button>`}expItem.appendChild(contentDiv);expItem.appendChild(actionDiv);list.appendChild(expItem)})}function showSimpleToast(message,type = 'success'){const toast = document.createElement('div');toast.textContent = message;toast.style.cssText = ` position:fixed;top:20px;right:20px;background:${type === 'success' ? '#4caf50':'#ff9800'};color:white;padding:10px 20px;border-radius:5px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:toastSlideIn 0.3s ease;`;document.body.appendChild(toast);setTimeout(()=>{toast.style.animation = 'toastSlideOut 0.3s ease';setTimeout(()=> toast.remove(),300)},3000)}const toastStyle = document.createElement('style');toastStyle.textContent = ` @keyframes toastSlideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes toastSlideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;document.head.appendChild(toastStyle);function getDrawingTypeText(type){const types ={'design':'è®¾è®¡å›¾çº¸','quote':'æŠ¥ä»·è¡¨','other':'å…¶ä»–'};return types[type] || 'æœªçŸ¥'}function getFileIcon(fileType){if(fileType.includes('pdf'))return 'ğŸ“•';if(fileType.includes('excel')|| fileType.includes('sheet'))return 'ğŸ“Š';if(fileType.includes('word'))return 'ğŸ“';if(fileType.includes('csv'))return 'ğŸ“‹';if(fileType.includes('image'))return 'ğŸ–¼ï¸';return 'ğŸ“„'}function getMimeTypeFromFileName(fileName){const ext = fileName.split('.').pop().toLowerCase();const mimeTypes ={'jpg':'image/jpeg','jpeg':'image/jpeg','png':'image/png','gif':'image/gif','webp':'image/webp','bmp':'image/bmp','pdf':'application/pdf','xls':'application/vnd.ms-excel','xlsx':'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','doc':'application/msword','docx':'application/vnd.openxmlformats-officedocument.wordprocessingml.document','csv':'text/csv','txt':'text/plain','json':'application/json'};return mimeTypes[ext] || 'application/octet-stream'}function getExtensionFromMimeType(mimeType){const mimeMap ={'image/jpeg':'jpg','image/png':'png','image/gif':'gif','image/webp':'webp','image/bmp':'bmp','application/pdf':'pdf','application/vnd.ms-excel':'xls','application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':'xlsx','application/msword':'doc','application/vnd.openxmlformats-officedocument.wordprocessingml.document':'docx','text/csv':'csv','text/plain':'txt','application/json':'json'};return mimeMap[mimeType] || 'bin'}function getExtensionFromFileName(fileName){if(!fileName)return null;const parts = fileName.split('.');return parts.length > 1 ? parts[parts.length - 1].toLowerCase():null}function removeAllBase64Data(sitesArray){if(!sitesArray)return;sitesArray.forEach(site =>{const siteName =(site.name || `site_${site.id}`).replace(/[\\/:*?"\u003c\u003e\u007c\u005d\u002f\u0067\u002c\u0027\u005f\u0027\u0029\u003b\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0029\u007b\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u0066\u006f\u0072\u0045\u0061\u0063\u0068\u0028\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u002c\u0069\u006e\u0064\u0065\u0078\u0029\u003d\u003e\u007b\u0069\u0066\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u0026\u0026\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0069\u006d\u0061\u0067\u0065\u005c\u002f\u0028\u005c\u0077\u002b\u0029\u003b\u002f\u0029\u003f\u002e\u005b\u0031\u005d\u0020\u007c\u007c\u0020\u0027\u006a\u0070\u0067\u0027\u003b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u003d\u0020\u0060\u005b\u0050\u0048\u004f\u0054\u004f\u003a\u0024\u007b\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u007d\u002f\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002f\u0072\u0065\u0070\u0061\u0069\u0072\u005f\u0024\u007b\u0069\u006e\u0064\u0065\u0078\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u005d\u0060\u003b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0068\u0061\u0073\u0050\u0068\u006f\u0074\u006f\u0020\u003d\u0020\u0074\u0072\u0075\u0065\u007d\u007d\u0029\u007d\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0029\u007b\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u0066\u006f\u0072\u0045\u0061\u0063\u0068\u0028\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002c\u0069\u006e\u0064\u0065\u0078\u0029\u003d\u003e\u007b\u0069\u0066\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u0020\u0026\u0026\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0061\u0074\u0063\u0068\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0028\u005b\u005e\u003b\u005d\u002b\u0029\u003b\u002f\u0029\u003b\u0069\u0066\u0028\u006d\u0061\u0074\u0063\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0028\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0029\u007c\u007c\u0020\u0027\u0062\u0069\u006e\u0027\u003b\u006c\u0065\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0060\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u005f\u0024\u007b\u0069\u006e\u0064\u0065\u0078\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u0060\u003b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002e\u0072\u0065\u0070\u006c\u0061\u0063\u0065\u0028\u002f\u005b\u005c\u005c\u002f\u003a\u002a\u003f"<>|]/g,'_');drawing.file = `[FILE:${siteName}/drawings/${fileName}]`;drawing.hasFile = true}}})}})}function checkIfHasFiles(sitesArray){let hasFiles = false;if(!sitesArray)return false;sitesArray.forEach(site =>{if(site.repairs && site.repairs.some(repair => repair.photo && repair.photo.startsWith('data:'))){hasFiles = true}if(site.drawings && site.drawings.some(drawing => drawing.file && drawing.file.startsWith('data:'))){hasFiles = true}});return hasFiles}function resizeImage(file,maxDimension,callback){if(!maxDimension)maxDimension = 500;const reader = new FileReader();reader.onload = function(e){const img = new Image();img.onload = function(){const originalWidth = img.width;const originalHeight = img.height;const scaleRatio = maxDimension / Math.max(originalWidth,originalHeight);if(scaleRatio >= 1){callback(e.target.result);return}const newWidth = Math.round(originalWidth * scaleRatio);const newHeight = Math.round(originalHeight * scaleRatio);const canvas = document.createElement('canvas');const ctx = canvas.getContext('2d');canvas.width = newWidth;canvas.height = newHeight;ctx.fillStyle = 'white';ctx.fillRect(0,0,newWidth,newHeight);ctx.drawImage(img,0,0,newWidth,newHeight);let dataUrl;const mimeType = file.type || 'image/jpeg';if(mimeType === 'image/jpeg'){dataUrl = canvas.toDataURL('image/jpeg',0.6)}else if(mimeType === 'image/png'){dataUrl = canvas.toDataURL('image/png')}else if(mimeType === 'image/webp'){dataUrl = canvas.toDataURL('image/webp',0.6)}else{dataUrl = canvas.toDataURL('image/jpeg',0.6)}callback(dataUrl)};img.src = e.target.result};reader.readAsDataURL(file)}function formatFileSize(bytes){if(bytes === 0)return '0 Bytes';const k = 1024;const sizes = ['Bytes','KB','MB','GB'];const i = Math.floor(Math.log(bytes)/ Math.log(k));return parseFloat((bytes / Math.pow(k,i)).toFixed(2))+ ' ' + sizes[i]}function formatDate(dateStr){if(!dateStr)return '';if(dateStr.match(/^\d{4}-\d{2}-\d{2}$/)){return dateStr}const date = new Date(dateStr);if(isNaN(date.getTime()))return dateStr;return date.toISOString().split('T')[0]}function calculateDaysLeft(endDate){if(!endDate)return 0;const end = new Date(endDate);const now = new Date();end.setHours(0,0,0,0);now.setHours(0,0,0,0);const diff = end - now;return Math.ceil(diff /(1000 * 60 * 60 * 24))}function getSiteStatus(progress,daysLeft){if(progress >= 100){return{class:'completed',text:'å·²å®Œæˆ'}}else if(daysLeft < 0){return{class:'delayed',text:'å·²é€¾æœŸ'}}else{return{class:'active',text:'è¿›è¡Œä¸­'}}}function generateId(){return Date.now().toString(36)+ Math.random().toString(36).substr(2)}function saveData(){try{localStorage.setItem('constructionSites',JSON.stringify(sites));localStorage.setItem('changeLog',JSON.stringify(changeLog))}catch(error){console.error('ä¿å­˜æ•°æ®å¤±è´¥:',error);alert('ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨æƒé™')}}function loadFromLocalStorage(){try{const savedSites = localStorage.getItem('constructionSites');const savedLog = localStorage.getItem('changeLog');if(savedSites){sites = JSON.parse(savedSites)}if(savedLog){changeLog = JSON.parse(savedLog)}}catch(error){console.error('ä» localStorage åŠ è½½æ•°æ®å¤±è´¥:',error);sites = [];changeLog = []}}async function saveToGitHub(){if(!GIST_CONFIG.configLoaded){const loaded = await loadGithubConfig();if(!loaded){showSimpleToast('GitHubé…ç½®æœªå®Œæˆï¼Œæ— æ³•åŒæ­¥','error');return false}}if(isSyncing){showSimpleToast('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè¯·ç¨åé‡è¯•','warning');return false}if(!confirm('å³å°†ä¿å­˜åˆ°äº‘ç«¯ï¼š\n1. æ–‡æœ¬æ•°æ®ä¼šä¸Šä¼ åˆ°äº‘ç«¯\n2. å›¾ç‰‡åŠå›¾ç‰‡ç›¸å…³æ–‡ä»¶ä¼šæ‰“åŒ…ä¸ºZIPä¸‹è½½\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')){return}isSyncing = true;try{const textData ={sites:JSON.parse(JSON.stringify(sites)),changeLog:JSON.parse(JSON.stringify(changeLog)),lastSync:new Date().toISOString(),user:currentUser.name,syncVersion:'2.2',hasSeparateFiles:true,note:'æ­¤æ–‡ä»¶ä»…åŒ…å«æ–‡æœ¬æ•°æ®ï¼Œå›¾ç‰‡å’Œæ–‡ä»¶è¯·ä½¿ç”¨ZIPåŒ…'};removeAllBase64Data(textData.sites);const hasFiles = checkIfHasFiles(sites);const response = await fetch(`https:method:'PATCH',headers:{'Authorization':`token ${GIST_CONFIG.GITHUB_TOKEN}`,'Content-Type':'application/json','Accept':'application/vnd.github.v3+json'},body:JSON.stringify({description:`å·¥åœ°è£…é¥°ç®¡ç†ç³»ç»Ÿæ•°æ® - ${new Date().toLocaleString()}`,files:{'construction_data.json':{content:JSON.stringify(textData,null,2)}}})});if(response.ok){showSimpleToast('æ–‡æœ¬æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');if(hasFiles){setTimeout(()=>{if(confirm('æ£€æµ‹åˆ°å›¾ç‰‡å’Œæ–‡ä»¶æ•°æ®ï¼Œå³å°†ä¸‹è½½å›¾ç‰‡æ•°æ®åŒ…ï¼ˆä»…åŒ…å«å›¾ç‰‡å’Œæ–‡ä»¶å¤¹ç»“æ„ï¼‰')){saveImagesZipOnly()}},500)}return true}else{const error = await response.text();console.error('GitHubåŒæ­¥å¤±è´¥:',error);showSimpleToast('äº‘ç«¯ä¿å­˜å¤±è´¥','error');return false}}catch(error){console.error('GitHubåŒæ­¥å¼‚å¸¸:',error);showSimpleToast('ä¿å­˜å¤±è´¥:' + error.message,'error');return false}finally{isSyncing = false}}async function loadFromGitHub(){if(!GIST_CONFIG.configLoaded){const loaded = await loadGithubConfig();if(!loaded){showSimpleToast('GitHubé…ç½®æœªå®Œæˆï¼Œæ— æ³•åŒæ­¥','error');return false}}if(!confirm('ä»äº‘ç«¯åŠ è½½æ•°æ®å°†ä¸ç°æœ‰æ•°æ®åˆå¹¶ã€‚ç›¸åŒIDçš„å·¥åœ°å°†è¢«è¦†ç›–ï¼Œæ–°å·¥åœ°å°†è¢«æ·»åŠ ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')){return}try{let response;if(GIST_CONFIG.GITHUB_TOKEN){response = await fetch(`https:headers:{'Authorization':`token ${GIST_CONFIG.GITHUB_TOKEN}`,'Accept':'application/vnd.github.v3+json'}})}else{response = await fetch(`https:headers:{'Accept':'application/vnd.github.v3+json'}})}if(!response.ok){throw new Error(`HTTP ${response.status}:${response.statusText}`)}const gist = await response.json();const fileContent = gist.files['construction_data.json']?.content;if(!fileContent){throw new Error('Gist ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®æ–‡ä»¶')}const data = JSON.parse(fileContent);const cloudSites = data.sites || [];const cloudChangeLog = data.changeLog || [];let addedCount = 0;let updatedCount = 0;for(const cloudSite of cloudSites){const existingIndex = sites.findIndex(s => s.id === cloudSite.id);if(existingIndex >= 0){const existingSite = sites[existingIndex];['name','startDate','endDate','progress','basicQuote','materialQuote','equipmentQuote','furnitureQuote','otherQuote'].forEach(field =>{if(cloudSite[field] !== undefined){existingSite[field] = cloudSite[field]}});['todos','expenses','requirements','repairs','workers','addRemoveItems','drawings','experiences'].forEach(arrayField =>{if(cloudSite[arrayField] && Array.isArray(cloudSite[arrayField])){if(!existingSite[arrayField]){existingSite[arrayField] = []}const existingIds = new Set(existingSite[arrayField].map(item => item.id));cloudSite[arrayField].forEach(cloudItem =>{if(!existingIds.has(cloudItem.id)){existingSite[arrayField].push(cloudItem)}})}});updatedCount++}else{sites.push(cloudSite);addedCount++}}const existingLogKeys = new Set(changeLog.map(log => `${log.timestamp}-${log.user}-${log.action}`));cloudChangeLog.forEach(log =>{const logKey = `${log.timestamp}-${log.user}-${log.action}`;if(!existingLogKeys.has(logKey)){changeLog.unshift(log);existingLogKeys.add(logKey)}});if(changeLog.length > 1000){changeLog = changeLog.slice(0,1000)}saveData();renderSiteList();showSimpleToast(`äº‘ç«¯æ•°æ®å·²åˆå¹¶(æ–°å¢:${addedCount},æ›´æ–°:${updatedCount})`);if(currentSiteId){const site = sites.find(s => s.id === currentSiteId);if(site)loadSiteData(site)}return true}catch(error){console.error('ä»GitHubåŠ è½½å¤±è´¥:',error);showSimpleToast('äº‘ç«¯åŠ è½½å¤±è´¥','error');return false}}async function saveToJsFile(){try{if(!currentUser){alert('è¯·å…ˆç™»å½•ï¼');return}if(!confirm('å³å°†ä¸‹è½½å®Œæ•´æ•°æ®å¤‡ä»½ZIPåŒ…ï¼ŒåŒ…å«ï¼š\n1. æ— base64å›¾ç‰‡çš„æ–‡æœ¬æ•°æ®(shuju_light.js)\n2. æ‰€æœ‰å›¾ç‰‡å’Œæ–‡ä»¶\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')){return}const textData ={sites:[],changeLog:changeLog,exportTime:new Date().toLocaleString('zh-CN'),exportedBy:currentUser.name,dataVersion:'2.2',note:'æ­¤æ–‡ä»¶ä»…åŒ…å«æ–‡æœ¬æ•°æ®ï¼Œå›¾ç‰‡å’Œæ–‡ä»¶è¯·æŸ¥çœ‹ZIPåŒ…ä¸­çš„shujuæ–‡ä»¶å¤¹'};for(const site of sites){const siteCopy ={id:site.id,name:site.name,startDate:site.startDate,endDate:site.endDate,progress:site.progress,todos:site.todos || [],expenses:site.expenses || [],requirements:site.requirements || [],repairs:[],workers:site.workers || [],addRemoveItems:site.addRemoveItems || [],drawings:[],experiences:site.experiences || [],basicQuote:site.basicQuote || 0,materialQuote:site.materialQuote || 0,equipmentQuote:site.equipmentQuote || 0,furnitureQuote:site.furnitureQuote || 0,otherQuote:site.otherQuote || 0,addRemoveTotal:site.addRemoveTotal || 0,totalQuote:site.totalQuote || 0,maxImageDimension:site.maxImageDimension || 800,dataVersion:'2.2'};if(site.repairs && site.repairs.length > 0){for(let i = 0;i < site.repairs.length;i++){const repair = site.repairs[i];const repairCopy ={...repair};if(repair.photo && repair.photo.startsWith('data:')){const extension = getExtensionFromMimeType(repair.photo.match(/^data:([^;]+);/)?.[1])|| 'jpg';repairCopy.photo = `[PHOTO:${site.name || site.id}/repairs/repair_${i + 1}.${extension}]`;repairCopy.hasPhoto = true}siteCopy.repairs.push(repairCopy)}}if(site.drawings && site.drawings.length > 0){for(let i = 0;i < site.drawings.length;i++){const drawing = site.drawings[i];const drawingCopy ={...drawing};if(drawing.file && drawing.file.startsWith('data:')){const extension = getExtensionFromMimeType(drawing.fileType)|| getExtensionFromFileName(drawing.fileName)|| 'bin';drawingCopy.file = `[FILE:${site.name || site.id}/drawings/${drawing.fileName || `drawing_${i + 1}.${extension}`}]`;drawingCopy.hasFile = true}siteCopy.drawings.push(drawingCopy)}}textData.sites.push(siteCopy)}await generateAndDownloadZip(textData);addChangeLog('å¤‡ä»½å®Œæ•´æ•°æ®','ä¸‹è½½äº†åŒ…å«å›¾ç‰‡å’Œæ— base64æ–‡æœ¬æ•°æ®çš„å®Œæ•´ZIPåŒ…')}catch(error){console.error('ä¿å­˜å¤±è´¥:',error);alert('ä¿å­˜å¤±è´¥ï¼š' + error.message)}}async function generateAndDownloadZip(textData){try{if(typeof JSZip === 'undefined'){alert('JSZip åº“æœªåŠ è½½ï¼Œæ— æ³•ç”Ÿæˆ ZIP æ–‡ä»¶');return}const zip = new JSZip();const jsContent = ` const savedData = ${JSON.stringify(textData,null,2)};`;zip.file('shuju_light.js',jsContent);const shujuFolder = zip.folder('shuju');const locationInfo ={info:'å›¾ç‰‡å’Œæ–‡ä»¶ä½ç½®ä¿¡æ¯',generated:new Date().toLocaleString('zh-CN'),user:currentUser.name,totalSites:sites.length,sites:[]};for(let i = 0;i < sites.length;i++){const site = sites[i];const siteName =(site.name || `å·¥åœ°_${site.id}`).replace(/[\\/:*?"\u003c\u003e\u007c\u005d\u002f\u0067\u002c\u0027\u005f\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0073\u0068\u0075\u006a\u0075\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u0020\u003d\u007b\u0069\u0064\u003a\u0073\u0069\u0074\u0065\u002e\u0069\u0064\u002c\u006e\u0061\u006d\u0065\u003a\u0073\u0069\u0074\u0065\u002e\u006e\u0061\u006d\u0065\u002c\u0066\u006f\u006c\u0064\u0065\u0072\u003a\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u002c\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u003a\u005b\u005d\u002c\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u003a\u005b\u005d\u007d\u003b\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u003e\u0020\u0030\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0027\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0027\u0029\u003b\u0066\u006f\u0072\u0028\u006c\u0065\u0074\u0020\u006a\u0020\u003d\u0020\u0030\u003b\u006a\u0020\u003c\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u003b\u006a\u002b\u002b\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u005b\u006a\u005d\u003b\u0069\u0066\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u0026\u0026\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0061\u0074\u0063\u0068\u0020\u003d\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0028\u005b\u005e\u003b\u005d\u002b\u0029\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0028\u002e\u002b\u0029\u0024\u002f\u0029\u003b\u0069\u0066\u0028\u006d\u0061\u0074\u0063\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0032\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0028\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0029\u007c\u007c\u0020\u0027\u006a\u0070\u0067\u0027\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0060\u0072\u0065\u0070\u0061\u0069\u0072\u005f\u0024\u007b\u006a\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u0060\u003b\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u0069\u006c\u0065\u0028\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002c\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u002c\u007b\u0062\u0061\u0073\u0065\u0036\u0034\u003a\u0074\u0072\u0075\u0065\u007d\u0029\u003b\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u0070\u0075\u0073\u0068\u0028\u007b\u0069\u006e\u0064\u0065\u0078\u003a\u006a\u002c\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u0064\u003a\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u002c\u0072\u0065\u0070\u0061\u0069\u0072\u0043\u006f\u006e\u0074\u0065\u006e\u0074\u003a\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u002c\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u003a\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002c\u0070\u0061\u0074\u0068\u003a\u0060\u0024\u007b\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u007d\u002f\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002f\u0024\u007b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u007d\u0060\u002c\u0074\u0069\u006d\u0065\u0073\u0074\u0061\u006d\u0070\u003a\u006e\u0065\u0077\u0020\u0044\u0061\u0074\u0065\u0028\u0029\u002e\u0074\u006f\u0049\u0053\u004f\u0053\u0074\u0072\u0069\u006e\u0067\u0028\u0029\u007d\u0029\u007d\u007d\u007d\u007d\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u003e\u0020\u0030\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0027\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0027\u0029\u003b\u0066\u006f\u0072\u0028\u006c\u0065\u0074\u0020\u006a\u0020\u003d\u0020\u0030\u003b\u006a\u0020\u003c\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u003b\u006a\u002b\u002b\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u005b\u006a\u005d\u003b\u0069\u0066\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u0020\u0026\u0026\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0061\u0074\u0063\u0068\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0028\u005b\u005e\u003b\u005d\u002b\u0029\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0028\u002e\u002b\u0029\u0024\u002f\u0029\u003b\u0069\u0066\u0028\u006d\u0061\u0074\u0063\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0032\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0028\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0029\u007c\u007c\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u0046\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u007c\u007c\u0020\u0027\u0062\u0069\u006e\u0027\u003b\u006c\u0065\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0060\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u005f\u0024\u007b\u006a\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u0060\u003b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002e\u0072\u0065\u0070\u006c\u0061\u0063\u0065\u0028\u002f\u005b\u005c\u005c\u002f\u003a\u002a\u003f"<>|]/g,'_');drawingsFolder.file(fileName,base64Data,{base64:true});siteInfo.drawings.push({index:j,drawingId:drawing.id,drawingType:drawing.type,fileName:fileName,originalName:drawing.fileName,path:`${siteName}/drawings/${fileName}`,timestamp:new Date().toISOString()})}}}}if(siteInfo.repairs.length > 0 || siteInfo.drawings.length > 0){locationInfo.sites.push(siteInfo)}}zip.file('æ–‡ä»¶ä½ç½®ä¿¡æ¯.json',JSON.stringify(locationInfo,null,2));const readmeContent = `å·¥åœ°è£…é¥°ç®¡ç†ç³»ç»Ÿå®Œæ•´æ•°æ®å¤‡ä»½åŒ… æ–‡ä»¶ç»“æ„ï¼š â”œâ”€â”€ shuju_light.js # æ–‡æœ¬æ•°æ®æ–‡ä»¶ï¼ˆä¸åŒ…å«base64ï¼‰ â”œâ”€â”€ æ–‡ä»¶ä½ç½®ä¿¡æ¯.json # å›¾ç‰‡å’Œæ–‡ä»¶ä½ç½®ä¿¡æ¯ â””â”€â”€ shuju/ # æ–‡ä»¶å’Œå›¾ç‰‡æ–‡ä»¶å¤¹ â”œâ”€â”€ å·¥åœ°1/ # ç¬¬ä¸€ä¸ªå·¥åœ°æ–‡ä»¶å¤¹ â”‚ â”œâ”€â”€ repairs/ # ç»´ä¿®å›¾ç‰‡ â”‚ â””â”€â”€ drawings/ # å›¾çº¸æ–‡ä»¶ â”œâ”€â”€ å·¥åœ°2/ â”‚ â”œâ”€â”€ repairs/ â”‚ â””â”€â”€ drawings/ â””â”€â”€ ... æ¢å¤è¯´æ˜ï¼š 1. å°†æ­¤ZIPåŒ…è§£å‹åˆ°ç½‘ç«™æ ¹ç›®å½• 2. ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½ shuju_light.js å’Œå¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ 3. å¦‚éœ€æ‰‹åŠ¨åŠ è½½ï¼Œå¯ä½¿ç”¨"\u4ece\u6587\u4ef6\u52a0\u8f7d\u6570\u636e"åŠŸèƒ½ ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}ç”Ÿæˆç”¨æˆ·ï¼š${currentUser.name}æ•°æ®ç‰ˆæœ¬ï¼š${textData.dataVersion}`;zip.file('README_æ¢å¤è¯´æ˜.txt',readmeContent);const zipBlob = await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});const url = URL.createObjectURL(zipBlob);const a = document.createElement('a');a.href = url;a.download = `å·¥åœ°å®Œæ•´æ•°æ®å¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\ document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);console.log('å®Œæ•´æ•°æ®ZIPåŒ…å·²ç”Ÿæˆå¹¶ä¸‹è½½')}catch(error){console.error('ç”ŸæˆZIPåŒ…å¤±è´¥:',error);throw new Error('ç”ŸæˆZIPåŒ…å¤±è´¥ï¼š' + error.message)}}async function saveImagesZipOnly(){try{if(typeof JSZip === 'undefined'){alert('JSZip åº“æœªåŠ è½½ï¼Œæ— æ³•ç”Ÿæˆ ZIP æ–‡ä»¶');return}const zip = new JSZip();const readmeContent = `å·¥åœ°è£…é¥°ç®¡ç†ç³»ç»Ÿå›¾ç‰‡æ•°æ®åŒ… æ–‡ä»¶è¯´æ˜ï¼š 1. æ­¤ZIPåŒ…ä»…åŒ…å«å›¾ç‰‡å’Œæ–‡ä»¶æ•°æ® 2. æ–‡æœ¬æ•°æ®å·²ä¸Šä¼ åˆ°GitHub Gistäº‘ç«¯ 3. æ–‡ä»¶å¤¹ç»“æ„ï¼š å·¥åœ°åç§°/ â”œâ”€â”€ repairs/ # ç»´ä¿®å›¾ç‰‡æ–‡ä»¶å¤¹ â”‚ â”œâ”€â”€ repair_1.jpg â”‚ â””â”€â”€ repair_2.jpg â””â”€â”€ drawings/ # å›¾çº¸æ–‡ä»¶å¤¹ â”œâ”€â”€ drawing_1.pdf â””â”€â”€ drawing_2.xlsx æ¢å¤è¯´æ˜ï¼š 1. è¯·ç¡®ä¿å·²ä»äº‘ç«¯åŒæ­¥æ–‡æœ¬æ•°æ® 2. ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®è·¯å¾„åŠ è½½å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ 3. å¦‚éœ€æ‰‹åŠ¨åŠ è½½ï¼Œå¯ä½¿ç”¨"\u624b\u52a8\u52a0\u8f7d"åŠŸèƒ½ ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}ç”Ÿæˆç”¨æˆ·ï¼š${currentUser.name}`;zip.file('README_å›¾ç‰‡åŒ…è¯´æ˜.txt',readmeContent);let locationInfo ={info:'å›¾ç‰‡ä½ç½®ä¿¡æ¯æ–‡ä»¶ - ç”¨äºç³»ç»Ÿå®šä½å›¾ç‰‡',generated:new Date().toLocaleString('zh-CN'),user:currentUser.name,totalSites:sites.length,sites:[]};for(let i = 0;i < sites.length;i++){const site = sites[i];const siteName =(site.name || `å·¥åœ°_${site.id}`).replace(/[\\/:*?"\u003c\u003e\u007c\u005d\u002f\u0067\u002c\u0027\u005f\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u007a\u0069\u0070\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u0020\u003d\u007b\u0069\u0064\u003a\u0073\u0069\u0074\u0065\u002e\u0069\u0064\u002c\u006e\u0061\u006d\u0065\u003a\u0073\u0069\u0074\u0065\u002e\u006e\u0061\u006d\u0065\u002c\u0066\u006f\u006c\u0064\u0065\u0072\u003a\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u002c\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u003a\u005b\u005d\u002c\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u003a\u005b\u005d\u007d\u003b\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u003e\u0020\u0030\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0027\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0027\u0029\u003b\u0066\u006f\u0072\u0028\u006c\u0065\u0074\u0020\u006a\u0020\u003d\u0020\u0030\u003b\u006a\u0020\u003c\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u003b\u006a\u002b\u002b\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u005b\u006a\u005d\u003b\u0069\u0066\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u0026\u0026\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0061\u0074\u0063\u0068\u0020\u003d\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0028\u005b\u005e\u003b\u005d\u002b\u0029\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0028\u002e\u002b\u0029\u0024\u002f\u0029\u003b\u0069\u0066\u0028\u006d\u0061\u0074\u0063\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0032\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0028\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0029\u007c\u007c\u0020\u0027\u006a\u0070\u0067\u0027\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0060\u0072\u0065\u0070\u0061\u0069\u0072\u005f\u0024\u007b\u006a\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u0060\u003b\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u0069\u006c\u0065\u0028\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002c\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u002c\u007b\u0062\u0061\u0073\u0065\u0036\u0034\u003a\u0074\u0072\u0075\u0065\u007d\u0029\u003b\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u0070\u0075\u0073\u0068\u0028\u007b\u0069\u006e\u0064\u0065\u0078\u003a\u006a\u002c\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u0064\u003a\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0069\u0064\u002c\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u003a\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002c\u0070\u0061\u0074\u0068\u003a\u0060\u0024\u007b\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u007d\u002f\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002f\u0024\u007b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u007d\u0060\u002c\u0074\u0069\u006d\u0065\u0073\u0074\u0061\u006d\u0070\u003a\u006e\u0065\u0077\u0020\u0044\u0061\u0074\u0065\u0028\u0029\u002e\u0074\u006f\u0049\u0053\u004f\u0053\u0074\u0072\u0069\u006e\u0067\u0028\u0029\u007d\u0029\u007d\u007d\u007d\u007d\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u003e\u0020\u0030\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u0028\u0027\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0027\u0029\u003b\u0066\u006f\u0072\u0028\u006c\u0065\u0074\u0020\u006a\u0020\u003d\u0020\u0030\u003b\u006a\u0020\u003c\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u003b\u006a\u002b\u002b\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u005b\u006a\u005d\u003b\u0069\u0066\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u0020\u0026\u0026\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u0073\u0074\u0061\u0072\u0074\u0073\u0057\u0069\u0074\u0068\u0028\u0027\u0064\u0061\u0074\u0061\u003a\u0027\u0029\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0061\u0074\u0063\u0068\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u002e\u006d\u0061\u0074\u0063\u0068\u0028\u002f\u005e\u0064\u0061\u0074\u0061\u003a\u0028\u005b\u005e\u003b\u005d\u002b\u0029\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0028\u002e\u002b\u0029\u0024\u002f\u0029\u003b\u0069\u0066\u0028\u006d\u0061\u0074\u0063\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0044\u0061\u0074\u0061\u0020\u003d\u0020\u006d\u0061\u0074\u0063\u0068\u005b\u0032\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0020\u003d\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0028\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0029\u007c\u007c\u0020\u0067\u0065\u0074\u0045\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u0046\u0072\u006f\u006d\u0046\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u007c\u007c\u0020\u0027\u0062\u0069\u006e\u0027\u003b\u006c\u0065\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0060\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u005f\u0024\u007b\u006a\u0020\u002b\u0020\u0031\u007d\u002e\u0024\u007b\u0065\u0078\u0074\u0065\u006e\u0073\u0069\u006f\u006e\u007d\u0060\u003b\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u002e\u0072\u0065\u0070\u006c\u0061\u0063\u0065\u0028\u002f\u005b\u005c\u005c\u002f\u003a\u002a\u003f"<>|]/g,'_');drawingsFolder.file(fileName,base64Data,{base64:true});siteInfo.drawings.push({index:j,drawingId:drawing.id,fileName:fileName,originalName:drawing.fileName,path:`${siteName}/drawings/${fileName}`,timestamp:new Date().toISOString()})}}}}if(siteInfo.repairs.length > 0 || siteInfo.drawings.length > 0){locationInfo.sites.push(siteInfo)}}zip.file('æ–‡ä»¶ä½ç½®ä¿¡æ¯.json',JSON.stringify(locationInfo,null,2));const zipBlob = await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});const url = URL.createObjectURL(zipBlob);const a = document.createElement('a');a.href = url;a.download = `å·¥åœ°å›¾ç‰‡æ•°æ®åŒ…_${new Date().toLocaleDateString('zh-CN').replace(/\ document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);addChangeLog('ä¿å­˜äº‘ç«¯å›¾ç‰‡åŒ…','ä¿å­˜äº†ä»…åŒ…å«å›¾ç‰‡çš„ZIPæ•°æ®åŒ…');showSimpleToast('å›¾ç‰‡æ•°æ®åŒ…å·²ä¿å­˜ï¼æ­¤ZIPä»…åŒ…å«å›¾ç‰‡ï¼Œæ–‡æœ¬æ•°æ®å·²åœ¨äº‘ç«¯ã€‚')}catch(error){console.error('ä¿å­˜å›¾ç‰‡ZIPå¤±è´¥:',error);alert('ä¿å­˜å›¾ç‰‡æ•°æ®åŒ…å¤±è´¥ï¼š' + error.message)}}function downloadJsonData(){if(!currentUser){alert('è¯·å…ˆç™»å½•ï¼');return}try{const data ={sites:JSON.parse(JSON.stringify(sites)),changeLog:JSON.parse(JSON.stringify(changeLog)),exportTime:new Date().toLocaleString('zh-CN'),exportedBy:currentUser.name,dataVersion:'2.0'};const jsonStr = JSON.stringify(data,null,2);const blob = new Blob([jsonStr],{type:'application/json;charset=utf-8'});const url = URL.createObjectURL(blob);const a = document.createElement('a');a.href = url;a.download = `å·¥åœ°æ•°æ®_${new Date().toLocaleDateString('zh-CN').replace(/\ document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);addChangeLog('ä¸‹è½½JSONæ•°æ®','ä¸‹è½½äº†JSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶');alert('JSONæ•°æ®ä¸‹è½½æˆåŠŸï¼')}catch(error){console.error('ä¸‹è½½JSONæ•°æ®å¤±è´¥:',error);alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message)}}async function loadImagesZipOnly(){if(!currentUser){alert('è¯·å…ˆç™»å½•ï¼');return}const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);let message = 'è¯·é€‰æ‹©å›¾ç‰‡ZIPåŒ…ï¼Œç³»ç»Ÿå°†æ ¹æ®è·¯å¾„å°†å›¾ç‰‡åŠ è½½åˆ°ç°æœ‰æ•°æ®ä¸­ã€‚\næ³¨æ„ï¼šæ­¤æ“ä½œä¸ä¼šè¦†ç›–æ–‡æœ¬æ•°æ®ï¼Œåªæ›´æ–°å›¾ç‰‡ã€‚';if(isMobile){message += '\n\nâš ï¸ ç§»åŠ¨ç«¯æç¤ºï¼š\n1. æ–‡ä»¶é€‰æ‹©å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´\n2. è¯·ç¡®ä¿ZIPåŒ…å¤§å°åˆé€‚\n3. åŠ è½½å®Œæˆåä¼šæç¤ºæ‚¨'}if(!confirm(message)){return}const filePromise = new Promise((resolve,reject)=>{const input = document.createElement('input');input.type = 'file';input.accept = '.zip';input.style.cssText = 'position:fixed;top:-100px;left:-100px;width:1px;height:1px;';input.onchange =(e)=>{const file = e.target.files[0];if(file){resolve(file)}else{reject(new Error('æœªé€‰æ‹©æ–‡ä»¶'))}if(input.parentNode){document.body.removeChild(input)}};input.oncancel =()=>{reject(new Error('ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©'));if(input.parentNode){document.body.removeChild(input)}};document.body.appendChild(input);setTimeout(()=>{try{input.click()}catch(error){reject(error)}},100);setTimeout(()=>{if(input.parentNode && !input.files?.length){document.body.removeChild(input);reject(new Error('æ–‡ä»¶é€‰æ‹©è¶…æ—¶'))}},30000)});try{let loadingDiv = null;if(isMobile){loadingDiv = document.createElement('div');loadingDiv.style.cssText = ` position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:20px 30px;border-radius:12px;z-index:999999;text-align:center;min-width:250px;box-shadow:0 10px 30px rgba(0,0,0,0.5);`;loadingDiv.innerHTML = ` <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0031\u0035\u0070\u0078\u003b\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0036\u0070\u0078\u003b\u0066\u006f\u006e\u0074\u002d\u0077\u0065\u0069\u0067\u0068\u0074\u003a\u0062\u006f\u006c\u0064\u003b">æ­£åœ¨å¤„ç†æ–‡ä»¶...</div> <div style="\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0033\u0070\u0078\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0062\u006f\u0074\u0074\u006f\u006d\u003a\u0031\u0035\u0070\u0078\u003b\u006f\u0070\u0061\u0063\u0069\u0074\u0079\u003a\u0030\u002e\u0039\u003b">è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´</div> <div style="\u0077\u0069\u0064\u0074\u0068\u003a\u0034\u0030\u0070\u0078\u003b\u0068\u0065\u0069\u0067\u0068\u0074\u003a\u0034\u0030\u0070\u0078\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u003a\u0033\u0070\u0078\u0020\u0073\u006f\u006c\u0069\u0064\u0020\u0072\u0067\u0062\u0061\u0028\u0032\u0035\u0035\u002c\u0032\u0035\u0035\u002c\u0032\u0035\u0035\u002c\u0030\u002e\u0033\u0029\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0072\u0061\u0064\u0069\u0075\u0073\u003a\u0035\u0030\u0025\u003b\u0062\u006f\u0072\u0064\u0065\u0072\u002d\u0074\u006f\u0070\u002d\u0063\u006f\u006c\u006f\u0072\u003a\u0077\u0068\u0069\u0074\u0065\u003b\u0061\u006e\u0069\u006d\u0061\u0074\u0069\u006f\u006e\u003a\u0073\u0070\u0069\u006e\u0020\u0031\u0073\u0020\u006c\u0069\u006e\u0065\u0061\u0072\u0020\u0069\u006e\u0066\u0069\u006e\u0069\u0074\u0065\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u003a\u0030\u0020\u0061\u0075\u0074\u006f\u003b"></div> `;document.body.appendChild(loadingDiv)}const file = await filePromise;console.log('å¼€å§‹å¤„ç†æ–‡ä»¶:',file.name,'å¤§å°:',formatFileSize(file.size));if(typeof JSZip === 'undefined'){throw new Error('JSZip åº“æœªåŠ è½½')}if(isMobile && loadingDiv){loadingDiv.querySelector('div:nth-child(1)').textContent = 'æ­£åœ¨è§£å‹æ–‡ä»¶...'}const zip = await JSZip.loadAsync(file);console.log('ZIPæ–‡ä»¶åŠ è½½æˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶æ•°:',Object.keys(zip.files).length);if(isMobile && loadingDiv){loadingDiv.querySelector('div:nth-child(1)').textContent = 'æ­£åœ¨æ¢å¤å›¾ç‰‡...'}const result = await restoreImagesFromZip(zip);console.log('å›¾ç‰‡æ¢å¤å®Œæˆ:',result);saveData();renderSiteList();if(currentSiteId){const site = sites.find(s => s.id === currentSiteId);if(site)loadSiteData(site)}let resultMessage = `å›¾ç‰‡åŠ è½½å®Œæˆï¼\næˆåŠŸåŠ è½½:${result.restoredCount}ä¸ªæ–‡ä»¶`;if(result.failedCount > 0){resultMessage += `\nå¤±è´¥:${result.failedCount}ä¸ªæ–‡ä»¶`}addChangeLog('åŠ è½½å›¾ç‰‡åŒ…','ä»ZIPåŒ…åŠ è½½äº†å›¾ç‰‡åˆ°ç°æœ‰æ•°æ®');if(isMobile && loadingDiv && loadingDiv.parentNode){document.body.removeChild(loadingDiv)}setTimeout(()=>{alert(resultMessage);showSimpleToast('å›¾ç‰‡æ•°æ®åŒ…åŠ è½½æˆåŠŸ')},300)}catch(error){console.error('åŠ è½½å›¾ç‰‡ZIPå¤±è´¥:',error);const loadingDiv = document.querySelector('div[style*="\u0070\u006f\u0073\u0069\u0074\u0069\u006f\u006e\u003a\u0066\u0069\u0078\u0065\u0064\u003b\u0074\u006f\u0070\u003a\u0035\u0030\u0025"]');if(loadingDiv && loadingDiv.parentNode){document.body.removeChild(loadingDiv)}let errorMessage = 'åŠ è½½å¤±è´¥ï¼š' + error.message;if(error.message.includes('ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©')){errorMessage = 'æ–‡ä»¶é€‰æ‹©å·²å–æ¶ˆ'}else if(error.message.includes('è¶…æ—¶')){errorMessage = 'æ–‡ä»¶é€‰æ‹©è¶…æ—¶ï¼Œè¯·é‡è¯•'}else if(error.message.includes('memory')|| error.message.includes('å¤ªå¤§')){errorMessage = 'æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº50MBçš„æ–‡ä»¶'}alert(errorMessage)}}async function restoreImagesFromZip(zip){let restoredCount = 0;let failedCount = 0;const locationInfoFile = zip.file('æ–‡ä»¶ä½ç½®ä¿¡æ¯.json');if(locationInfoFile){try{const locationInfo = JSON.parse(await locationInfoFile.async('text'));console.log('æ‰¾åˆ°ä½ç½®ä¿¡æ¯æ–‡ä»¶:',locationInfo);for(const siteInfo of locationInfo.sites){const site = sites.find(s =>{if(s.id === siteInfo.id)return true;const siteNameNormalized =(s.name || `site_${s.id}`).replace(/[\\/:*?"\u003c\u003e\u007c\u005d\u002f\u0067\u002c\u0027\u005f\u0027\u0029\u003b\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u004e\u006f\u0072\u006d\u0061\u006c\u0069\u007a\u0065\u0064\u0020\u003d\u003d\u003d\u0020\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u007d\u0029\u003b\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u0029\u007b\u0066\u006f\u0072\u0028\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u0020\u006f\u0066\u0020\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0073\u002e\u0066\u0069\u006e\u0064\u0028\u0072\u0020\u003d\u003e\u007b\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0072\u002e\u0069\u0064\u0020\u003d\u003d\u003d\u0020\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u0064\u0020\u007c\u007c\u0028\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u0026\u0026\u0020\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u002e\u0069\u006e\u0063\u006c\u0075\u0064\u0065\u0073\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u0029\u007d\u0029\u003b\u0069\u0066\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u0020\u003d\u0020\u007a\u0069\u0070\u002e\u0066\u0069\u006c\u0065\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u0029\u003b\u0069\u0066\u0028\u0066\u0069\u006c\u0065\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0020\u003d\u0020\u0061\u0077\u0061\u0069\u0074\u0020\u0066\u0069\u006c\u0065\u002e\u0061\u0073\u0079\u006e\u0063\u0028\u0027\u0062\u0061\u0073\u0065\u0036\u0034\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u0067\u0065\u0074\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0046\u0072\u006f\u006d\u0046\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0028\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u003b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0070\u0068\u006f\u0074\u006f\u0020\u003d\u0020\u0060\u0064\u0061\u0074\u0061\u003a\u0024\u007b\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u007d\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0024\u007b\u0062\u0061\u0073\u0065\u0036\u0034\u007d\u0060\u003b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u006c\u006f\u0067\u0028\u0060\u6062\u590d\u7ef4\u4fee\u56fe\u7247\u003a\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u007d\u0060\u0029\u003b\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u0065\u006c\u0073\u0065\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u0077\u0061\u0072\u006e\u0028\u0060\u005a\u0049\u0050\u4e2d\u672a\u627e\u5230\u6587\u4ef6\u003a\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u007d\u0060\u0029\u003b\u0066\u0061\u0069\u006c\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u007d\u007d\u0066\u006f\u0072\u0028\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u0020\u006f\u0066\u0020\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u0020\u0026\u0026\u0020\u0073\u0069\u0074\u0065\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0073\u002e\u0066\u0069\u006e\u0064\u0028\u0064\u0020\u003d\u003e\u007b\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0064\u002e\u0069\u0064\u0020\u003d\u003d\u003d\u0020\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u0064\u0020\u007c\u007c\u0028\u0064\u002e\u0066\u0069\u006c\u0065\u0020\u0026\u0026\u0020\u0064\u002e\u0066\u0069\u006c\u0065\u002e\u0069\u006e\u0063\u006c\u0075\u0064\u0065\u0073\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u0029\u007d\u0029\u003b\u0069\u0066\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u0020\u003d\u0020\u007a\u0069\u0070\u002e\u0066\u0069\u006c\u0065\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u0029\u003b\u0069\u0066\u0028\u0066\u0069\u006c\u0065\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0062\u0061\u0073\u0065\u0036\u0034\u0020\u003d\u0020\u0061\u0077\u0061\u0069\u0074\u0020\u0066\u0069\u006c\u0065\u002e\u0061\u0073\u0079\u006e\u0063\u0028\u0027\u0062\u0061\u0073\u0065\u0036\u0034\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0020\u003d\u0020\u0067\u0065\u0074\u004d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u0046\u0072\u006f\u006d\u0046\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0028\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0029\u003b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u002e\u0066\u0069\u006c\u0065\u0020\u003d\u0020\u0060\u0064\u0061\u0074\u0061\u003a\u0024\u007b\u006d\u0069\u006d\u0065\u0054\u0079\u0070\u0065\u007d\u003b\u0062\u0061\u0073\u0065\u0036\u0034\u002c\u0024\u007b\u0062\u0061\u0073\u0065\u0036\u0034\u007d\u0060\u003b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u006c\u006f\u0067\u0028\u0060\u6062\u590d\u56fe\u7eb8\u6587\u4ef6\u003a\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u007d\u0060\u0029\u003b\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u0065\u006c\u0073\u0065\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u0077\u0061\u0072\u006e\u0028\u0060\u005a\u0049\u0050\u4e2d\u672a\u627e\u5230\u6587\u4ef6\u003a\u0024\u007b\u0064\u0072\u0061\u0077\u0069\u006e\u0067\u0049\u006e\u0066\u006f\u002e\u0070\u0061\u0074\u0068\u007d\u0060\u0029\u003b\u0066\u0061\u0069\u006c\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u007d\u007d\u007d\u0065\u006c\u0073\u0065\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u0077\u0061\u0072\u006e\u0028\u0060\u672a\u627e\u5230\u5bf9\u5e94\u7684\u5de5\u5730\u003a\u0024\u007b\u0073\u0069\u0074\u0065\u0049\u006e\u0066\u006f\u002e\u0066\u006f\u006c\u0064\u0065\u0072\u007d\u0060\u0029\u007d\u007d\u007d\u0063\u0061\u0074\u0063\u0068\u0028\u0065\u0072\u0072\u006f\u0072\u0029\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u0077\u0061\u0072\u006e\u0028\u0027\u89e3\u6790\u4f4d\u7f6e\u4fe1\u606f\u6587\u4ef6\u5931\u8d25\u003a\u0027\u002c\u0065\u0072\u0072\u006f\u0072\u0029\u007d\u007d\u0069\u0066\u0028\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u0020\u003d\u003d\u003d\u0020\u0030\u0029\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u006c\u006f\u0067\u0028\u0027\u672a\u627e\u5230\u4f4d\u7f6e\u4fe1\u606f\u6587\u4ef6\uff0c\u6309\u6587\u4ef6\u5939\u7ed3\u6784\u6062\u590d\u002e\u002e\u002e\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u0050\u0072\u006f\u006d\u0069\u0073\u0065\u0073\u0020\u003d\u0020\u005b\u005d\u003b\u007a\u0069\u0070\u002e\u0066\u006f\u0072\u0045\u0061\u0063\u0068\u0028\u0028\u0072\u0065\u006c\u0061\u0074\u0069\u0076\u0065\u0050\u0061\u0074\u0068\u002c\u007a\u0069\u0070\u0045\u006e\u0074\u0072\u0079\u0029\u003d\u003e\u007b\u0069\u0066\u0028\u0021\u007a\u0069\u0070\u0045\u006e\u0074\u0072\u0079\u002e\u0064\u0069\u0072\u0029\u007b\u0066\u0069\u006c\u0065\u0050\u0072\u006f\u006d\u0069\u0073\u0065\u0073\u002e\u0070\u0075\u0073\u0068\u0028\u0070\u0072\u006f\u0063\u0065\u0073\u0073\u005a\u0069\u0070\u0046\u0069\u006c\u0065\u0028\u007a\u0069\u0070\u0045\u006e\u0074\u0072\u0079\u002c\u0072\u0065\u006c\u0061\u0074\u0069\u0076\u0065\u0050\u0061\u0074\u0068\u0029\u0029\u007d\u007d\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u0020\u003d\u0020\u0061\u0077\u0061\u0069\u0074\u0020\u0050\u0072\u006f\u006d\u0069\u0073\u0065\u002e\u0061\u006c\u006c\u0053\u0065\u0074\u0074\u006c\u0065\u0064\u0028\u0066\u0069\u006c\u0065\u0050\u0072\u006f\u006d\u0069\u0073\u0065\u0073\u0029\u003b\u0072\u0065\u0073\u0075\u006c\u0074\u0073\u002e\u0066\u006f\u0072\u0045\u0061\u0063\u0068\u0028\u0072\u0065\u0073\u0075\u006c\u0074\u0020\u003d\u003e\u007b\u0069\u0066\u0028\u0072\u0065\u0073\u0075\u006c\u0074\u002e\u0073\u0074\u0061\u0074\u0075\u0073\u0020\u003d\u003d\u003d\u0020\u0027\u0066\u0075\u006c\u0066\u0069\u006c\u006c\u0065\u0064\u0027\u0029\u007b\u0069\u0066\u0028\u0072\u0065\u0073\u0075\u006c\u0074\u002e\u0076\u0061\u006c\u0075\u0065\u0029\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u0065\u006c\u0073\u0065\u007b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u0077\u0061\u0072\u006e\u0028\u0027\u5904\u7406\u6587\u4ef6\u5931\u8d25\u003a\u0027\u002c\u0072\u0065\u0073\u0075\u006c\u0074\u002e\u0072\u0065\u0061\u0073\u006f\u006e\u0029\u003b\u0066\u0061\u0069\u006c\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002b\u002b\u007d\u007d\u0029\u007d\u0073\u0061\u0076\u0065\u0044\u0061\u0074\u0061\u0028\u0029\u003b\u0063\u006f\u006e\u0073\u006f\u006c\u0065\u002e\u006c\u006f\u0067\u0028\u0060\u56fe\u7247\u6062\u590d\u5b8c\u6210\u003a\u6210\u529f\u0020\u0024\u007b\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u007d\u4e2a\u002c\u5931\u8d25\u0020\u0024\u007b\u0066\u0061\u0069\u006c\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u007d\u4e2a\u0060\u0029\u003b\u0069\u0066\u0028\u002f\u0041\u006e\u0064\u0072\u006f\u0069\u0064\u007c\u0077\u0065\u0062\u004f\u0053\u007c\u0069\u0050\u0068\u006f\u006e\u0065\u007c\u0069\u0050\u0061\u0064\u007c\u0069\u0050\u006f\u0064\u007c\u0042\u006c\u0061\u0063\u006b\u0042\u0065\u0072\u0072\u0079\u007c\u0049\u0045\u004d\u006f\u0062\u0069\u006c\u0065\u007c\u004f\u0070\u0065\u0072\u0061\u0020\u004d\u0069\u006e\u0069\u002f\u0069\u002e\u0074\u0065\u0073\u0074\u0028\u006e\u0061\u0076\u0069\u0067\u0061\u0074\u006f\u0072\u002e\u0075\u0073\u0065\u0072\u0041\u0067\u0065\u006e\u0074\u0029\u0029\u007b\u0073\u0065\u0074\u0054\u0069\u006d\u0065\u006f\u0075\u0074\u0028\u0028\u0029\u003d\u003e\u007b\u0069\u0066\u0028\u0063\u0075\u0072\u0072\u0065\u006e\u0074\u0053\u0069\u0074\u0065\u0049\u0064\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0073\u002e\u0066\u0069\u006e\u0064\u0028\u0073\u0020\u003d\u003e\u0020\u0073\u002e\u0069\u0064\u0020\u003d\u003d\u003d\u0020\u0063\u0075\u0072\u0072\u0065\u006e\u0074\u0053\u0069\u0074\u0065\u0049\u0064\u0029\u003b\u0069\u0066\u0028\u0073\u0069\u0074\u0065\u0029\u007b\u006c\u006f\u0061\u0064\u0053\u0069\u0074\u0065\u0044\u0061\u0074\u0061\u0028\u0073\u0069\u0074\u0065\u0029\u003b\u0066\u0069\u0078\u004d\u006f\u0062\u0069\u006c\u0065\u0055\u0049\u0028\u0029\u007d\u007d\u007d\u002c\u0031\u0030\u0030\u0029\u007d\u0072\u0065\u0074\u0075\u0072\u006e\u007b\u0072\u0065\u0073\u0074\u006f\u0072\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u002c\u0066\u0061\u0069\u006c\u0065\u0064\u0043\u006f\u0075\u006e\u0074\u007d\u007d\u0061\u0073\u0079\u006e\u0063\u0020\u0066\u0075\u006e\u0063\u0074\u0069\u006f\u006e\u0020\u0070\u0072\u006f\u0063\u0065\u0073\u0073\u005a\u0069\u0070\u0046\u0069\u006c\u0065\u0028\u007a\u0069\u0070\u0045\u006e\u0074\u0072\u0079\u002c\u0072\u0065\u006c\u0061\u0074\u0069\u0076\u0065\u0050\u0061\u0074\u0068\u0029\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0070\u0061\u0074\u0068\u0050\u0061\u0072\u0074\u0073\u0020\u003d\u0020\u0072\u0065\u006c\u0061\u0074\u0069\u0076\u0065\u0050\u0061\u0074\u0068\u002e\u0073\u0070\u006c\u0069\u0074\u0028\u0027\u002f\u0027\u0029\u003b\u0069\u0066\u0028\u0070\u0061\u0074\u0068\u0050\u0061\u0072\u0074\u0073\u002e\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u003c\u0020\u0033\u0029\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0066\u0061\u006c\u0073\u0065\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0046\u006f\u006c\u0064\u0065\u0072\u0020\u003d\u0020\u0070\u0061\u0074\u0068\u0050\u0061\u0072\u0074\u0073\u005b\u0030\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0074\u0079\u0070\u0065\u0020\u003d\u0020\u0070\u0061\u0074\u0068\u0050\u0061\u0072\u0074\u0073\u005b\u0031\u005d\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0066\u0069\u006c\u0065\u004e\u0061\u006d\u0065\u0020\u003d\u0020\u0070\u0061\u0074\u0068\u0050\u0061\u0072\u0074\u0073\u002e\u0073\u006c\u0069\u0063\u0065\u0028\u0032\u0029\u002e\u006a\u006f\u0069\u006e\u0028\u0027\u002f\u0027\u0029\u003b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u0020\u003d\u0020\u0073\u0069\u0074\u0065\u0073\u002e\u0066\u0069\u006e\u0064\u0028\u0073\u0020\u003d\u003e\u007b\u0063\u006f\u006e\u0073\u0074\u0020\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u004e\u006f\u0072\u006d\u0061\u006c\u0069\u007a\u0065\u0064\u0020\u003d\u0028\u0073\u002e\u006e\u0061\u006d\u0065\u0020\u007c\u007c\u0020\u0060\u0073\u0069\u0074\u0065\u005f\u0024\u007b\u0073\u002e\u0069\u0064\u007d\u0060\u0029\u002e\u0072\u0065\u0070\u006c\u0061\u0063\u0065\u0028\u002f\u005b\u005c\u005c\u002f\u003a\u002a\u003f"<>|]/g,'_');return siteNameNormalized === siteFolder});if(!site){console.warn(`æœªæ‰¾åˆ°å¯¹åº”å·¥åœ°:${siteFolder}`);return false}const base64 = await zipEntry.async('base64');const mimeType = getMimeTypeFromFileName(fileName);if(type === 'repairs'){const repairIndex = extractIndexFromFileName(fileName,'repair');if(repairIndex !== null && site.repairs && site.repairs[repairIndex]){site.repairs[repairIndex].photo = `data:${mimeType};base64,${base64}`;console.log(`æ¢å¤ç»´ä¿®å›¾ç‰‡:${relativePath}-> å·¥åœ° ${site.name}çš„ç¬¬ ${repairIndex + 1}ä¸ªç»´ä¿®é¡¹`);return true}if(site.repairs){const repair = site.repairs.find(r =>{return r.photo &&(r.photo.includes(fileName)|| r.photo.includes(siteFolder))});if(repair){repair.photo = `data:${mimeType};base64,${base64}`;console.log(`é€šè¿‡æ–‡ä»¶ååŒ¹é…æ¢å¤ç»´ä¿®å›¾ç‰‡:${relativePath}`);return true}}}else if(type === 'drawings'){const drawingIndex = extractIndexFromFileName(fileName,'drawing');if(drawingIndex !== null && site.drawings && site.drawings[drawingIndex]){site.drawings[drawingIndex].file = `data:${mimeType};base64,${base64}`;site.drawings[drawingIndex].fileName = fileName;console.log(`æ¢å¤å›¾çº¸æ–‡ä»¶:${relativePath}-> å·¥åœ° ${site.name}çš„ç¬¬ ${drawingIndex + 1}ä¸ªå›¾çº¸`);return true}if(site.drawings){const drawing = site.drawings.find(d =>{return d.file &&(d.file.includes(fileName)|| d.file.includes(siteFolder))});if(drawing){drawing.file = `data:${mimeType};base64,${base64}`;drawing.fileName = fileName;console.log(`é€šè¿‡æ–‡ä»¶ååŒ¹é…æ¢å¤å›¾çº¸æ–‡ä»¶:${relativePath}`);return true}}}console.warn(`æ— æ³•åŒ¹é…æ–‡ä»¶:${relativePath}`);return false}function extractIndexFromFileName(fileName,prefix){const regex = new RegExp(`${prefix}_(\\d+)\\.`);const match = fileName.match(regex);return match ? parseInt(match[1],10)- 1:null}function editNoteAutoSave(type,id,cell){if(!canEditNote())return;const display = cell.querySelector('.note-display');const input = cell.querySelector('.note-edit-auto');if(display)display.style.display = 'none';if(input){input.style.display = 'block';input.focus();const length = input.value.length;input.setSelectionRange(length,length);if(display && display.textContent.includes('ç‚¹å‡»æ·»åŠ å¤‡æ³¨')){input.value = ''}}}function saveNoteAutoSave(event){const input = event.target;const type = input.getAttribute('data-type');const id = input.getAttribute('data-id');if(!type || !id)return;const site = sites.find(s => s.id === currentSiteId);if(!site)return;const collections ={'todo':site.todos,'expense':site.expenses,'requirement':site.requirements,'repair':site.repairs,'worker':site.workers,'addRemove':site.addRemoveItems,'drawing':site.drawings};const collection = collections[type];if(!collection)return;const item = collection.find(item => item.id === id);if(!item)return;const oldNote = item.note || '';const newNote = input.value.trim();if(!newNote){const display = input.parentElement.querySelector('.note-display');if(display){display.textContent = 'ç‚¹å‡»æ·»åŠ å¤‡æ³¨ï¼ˆ20å­—ç¬¦ä»¥å†…ï¼‰';display.style.display = ''}input.style.display = 'none';if(oldNote){item.note = '';saveData();addChangeLog(`æ¸…é™¤${getCollectionName(type)}å¤‡æ³¨`,`æ¸…é™¤äº†${item.item || item.content || item.name || 'æœªå‘½å'}çš„å¤‡æ³¨`)}return}if(oldNote === newNote){input.style.display = 'none';const display = input.parentElement.querySelector('.note-display');if(display)display.style.display = '';return}item.note = newNote;saveData();const display = input.parentElement.querySelector('.note-display');if(display){display.textContent = `å¤‡æ³¨ï¼š${newNote}`;display.style.display = ''}input.style.display = 'none';const itemName = item.item || item.content || item.name || 'æœªå‘½å';addChangeLog(`ç¼–è¾‘${getCollectionName(type)}å¤‡æ³¨`,`ä¿®æ”¹äº†${itemName}çš„å¤‡æ³¨`);showSimpleToast('å¤‡æ³¨å·²ä¿å­˜','success')}function handleNoteKeydown(event){if(event.key === 'Escape'){const input = event.target;input.value = input.defaultValue;input.style.display = 'none';const display = input.parentElement.querySelector('.note-display');if(display)display.style.display = ''}else if(event.key === 'Enter' && event.ctrlKey){event.preventDefault();event.target.blur()}}function getCollectionName(type){const names ={'todo':'å¾…åŠäº‹é¡¹','expense':'æ”¯å‡º','requirement':'å®¢æˆ·è¦æ±‚','repair':'ç»´ä¿®é¡¹','worker':'å·¥äºº','addRemove':'å¢å‡é¡¹','drawing':'å›¾çº¸'};return names[type] || 'é¡¹ç›®'}function editTime(element,id,timeField = 'time'){if(!canEditTime())return;const display = element.querySelector('.date-display');const input = element.querySelector('.date-edit');if(display)display.style.display = 'none';if(input){input.style.display = 'inline-block';input.focus()}}function saveTime(id,newTime,timeField = 'time'){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const searchCollections = [{collection:site.todos,type:'todo'},{collection:site.expenses,type:'expense'},{collection:site.requirements,type:'requirement'},{collection:site.repairs,type:'repair'},{collection:site.workers,type:'worker'},{collection:site.addRemoveItems,type:'addRemove'},{collection:site.drawings,type:'drawing'}];for(const{collection,type}of searchCollections){if(collection){const found = collection.find(item => item.id === id);if(found){const itemName = found.item || found.content || found.name || 'æœªå‘½å';found[timeField] = newTime;saveData();addChangeLog('ç¼–è¾‘æ—¶é—´',`ä¿®æ”¹äº†${itemName}çš„æ—¶é—´ä¸ºï¼š${newTime}`);return true}}}return false}function deleteItem(itemId,collectionName){if(!canDelete()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æ•°æ®ï¼');return false}if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ'))return false;const site = sites.find(s => s.id === currentSiteId);if(!site)return false;const collections ={'todo':{data:site.todos,name:'å¾…åŠäº‹é¡¹'},'expense':{data:site.expenses,name:'æ”¯å‡º'},'requirement':{data:site.requirements,name:'å®¢æˆ·è¦æ±‚'},'repair':{data:site.repairs,name:'ç»´ä¿®é¡¹'},'worker':{data:site.workers,name:'å·¥äºº'},'addRemove':{data:site.addRemoveItems,name:'å¢å‡é¡¹'},'drawing':{data:site.drawings,name:'å›¾çº¸'},'experience':{data:site.experiences,name:'ç»éªŒæ€»ç»“'}};const collection = collections[collectionName];if(!collection || !collection.data)return false;const index = collection.data.findIndex(item => item.id === itemId);if(index > -1){const item = collection.data[index];const itemName = item.item || item.content || item.name || 'æœªå‘½å';collection.data.splice(index,1);saveData();addChangeLog(`åˆ é™¤${collection.name}`,`åˆ é™¤äº†${collection.name}ï¼š${itemName}`);switch(collectionName){case 'todo':renderTodoList(site);break;case 'expense':renderExpenseList(site);break;case 'requirement':renderRequirementList(site);break;case 'repair':renderRepairList(site);break;case 'worker':renderWorkerList(site);break;case 'addRemove':renderAddRemoveList(site);break;case 'drawing':renderDrawingList(site);break;case 'experience':renderExperienceList(site);break}alert('åˆ é™¤æˆåŠŸï¼');return true}return false}function setupBackGestureLock(){let backGestureCount = 0;let backGestureTimer = null;history.pushState(null,null,window.location.href);window.addEventListener('popstate',function(e){e.preventDefault();backGestureCount++;if(backGestureCount === 1){const lockDiv = document.getElementById('backGestureLock');if(lockDiv){lockDiv.classList.add('show');setTimeout(()=>{lockDiv.classList.remove('show')},3000)}if(backGestureTimer)clearTimeout(backGestureTimer);backGestureTimer = setTimeout(()=>{backGestureCount = 0},1000)}else if(backGestureCount >= 2){if(confirm('ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ')){logout()}else{backGestureCount = 0}}history.pushState(null,null,window.location.href)})}function fixMobileUI(){const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(!isMobile)return;console.log('æ£€æµ‹åˆ°ç§»åŠ¨ç«¯ï¼Œä¿®å¤ç•Œé¢äº¤äº’...');const modalContent = document.querySelector('.modal-content');if(modalContent){modalContent.style.maxHeight = '80vh';modalContent.style.overflowY = 'auto';modalContent.style.WebkitOverflowScrolling = 'touch'}const inputs = document.querySelectorAll('input,select,textarea');inputs.forEach(input =>{input.style.fontSize = '16px';input.addEventListener('focus',function(){setTimeout(()=>{this.scrollIntoView({behavior:'smooth',block:'center'})},300)})});const buttons = document.querySelectorAll('.btn,.action-btn');buttons.forEach(btn =>{btn.style.minHeight = '44px';btn.style.minWidth = '44px';btn.style.cursor = 'pointer';btn.setAttribute('role','button');btn.setAttribute('aria-label',btn.textContent || 'æŒ‰é’®')});const tables = document.querySelectorAll('.data-table');tables.forEach(table =>{table.style.WebkitOverflowScrolling = 'touch';table.style.overflowX = 'auto'});const imagePreviews = document.querySelectorAll('.image-preview');imagePreviews.forEach(img =>{img.style.minHeight = '44px';img.style.minWidth = '44px';img.style.cursor = 'pointer'});const fileUploads = document.querySelectorAll('.file-upload-label');fileUploads.forEach(label =>{label.style.minHeight = '60px';label.style.display = 'flex';label.style.alignItems = 'center';label.style.justifyContent = 'center'});console.log('ç§»åŠ¨ç«¯ç•Œé¢ä¿®å¤å®Œæˆ')}function fixMobileTables(){const tables = document.querySelectorAll('.data-table');tables.forEach(table =>{table.style.fontSize = '12px';table.querySelectorAll('th,td').forEach(cell =>{cell.style.padding = '6px 4px'});table.querySelectorAll('.action-btn').forEach(btn =>{btn.style.padding = '4px 8px';btn.style.fontSize = '11px'})})}function optimizeMobileTables(){const tables = document.querySelectorAll('.data-table');if(tables.length === 0)return;tables.forEach(table =>{table.style.tableLayout = 'fixed';table.style.width = '100%';const ths = table.querySelectorAll('th');ths.forEach(th =>{th.style.position = 'sticky';th.style.top = '0';th.style.zIndex = '1';th.style.backgroundColor = '#f8f9fa';th.style.padding = '8px 6px';th.style.fontSize = '12px'});const tds = table.querySelectorAll('td');tds.forEach(td =>{td.style.padding = '8px 6px';td.style.fontSize = '12px';td.style.lineHeight = '1.3';td.style.wordBreak = 'break-word'});const actionBtns = table.querySelectorAll('.action-btn');actionBtns.forEach(btn =>{btn.style.padding = '4px 8px';btn.style.fontSize = '11px';btn.style.margin = '2px';btn.style.minHeight = '24px'})});const containers = document.querySelectorAll('.data-table-container');containers.forEach(container =>{container.style.overflowX = 'auto';container.style.WebkitOverflowScrolling = 'touch';container.style.scrollbarWidth = 'none';container.style.maxHeight = '60vh';container.style.borderRadius = '8px';container.style.border = '1px solid #dee2e6'})}function addChangeLog(action,details){if(!currentUser)return;const logEntry ={timestamp:new Date().toLocaleString('zh-CN'),user:currentUser.name,action:action,details:details,siteId:currentSiteId,siteName:currentSiteId ? sites.find(s => s.id === currentSiteId)?.name:''};changeLog.unshift(logEntry);if(changeLog.length > 1000){changeLog = changeLog.slice(0,1000)}saveData()}function showChangeLog(){document.getElementById('mainContent').style.display = 'none';document.getElementById('changeLogPage').style.display = 'block';const logList = document.getElementById('changeLogList');logList.innerHTML = '';if(changeLog.length === 0){logList.innerHTML = '<p class="\u006c\u006f\u0061\u0064\u0069\u006e\u0067">æš‚æ— æ›´æ”¹æ—¥å¿—</p>';return}changeLog.forEach(log =>{const logItem = document.createElement('div');logItem.className = 'change-log-item';logItem.innerHTML = ` <div class="\u0063\u0068\u0061\u006e\u0067\u0065\u002d\u006c\u006f\u0067\u002d\u0068\u0065\u0061\u0064\u0065\u0072"> <span>${log.user}- ${log.action}</span> <span class="\u0063\u0068\u0061\u006e\u0067\u0065\u002d\u006c\u006f\u0067\u002d\u0074\u0069\u006d\u0065">${log.timestamp}</span> </div> <div class="\u0063\u0068\u0061\u006e\u0067\u0065\u002d\u006c\u006f\u0067\u002d\u0063\u006f\u006e\u0074\u0065\u006e\u0074"> ${log.details}${log.siteName ? `<br><small>å·¥åœ°ï¼š${log.siteName}</small>`:''}</div> `;logList.appendChild(logItem)})}function hideChangeLog(){document.getElementById('mainContent').style.display = 'block';document.getElementById('changeLogPage').style.display = 'none'}function exportChangeLog(){const logText = changeLog.map(log => `[${log.timestamp}] ${log.user}- ${log.action}:${log.details}`).join('\n');const blob = new Blob([logText],{type:'text/plain'});const url = URL.createObjectURL(blob);const a = document.createElement('a');a.href = url;a.download = `æ›´æ”¹æ—¥å¿—_${new Date().toLocaleDateString('zh-CN')}.txt`;a.click();URL.revokeObjectURL(url)}function clearChangeLog(){if(!canClearLog()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ¸…ç©ºæ—¥å¿—ï¼');return}if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ›´æ”¹æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')){changeLog = [];saveData();showChangeLog();addChangeLog('æ¸…ç©ºæ—¥å¿—','ç”¨æˆ·æ¸…ç©ºäº†æ‰€æœ‰æ›´æ”¹æ—¥å¿—')}}window.loadGithubConfig = loadGithubConfig;window.manageGithubConfig = manageGithubConfig;window.showSimpleToast = showSimpleToast;window.saveToGitHub = saveToGitHub;window.loadFromGitHub = loadFromGitHub;window.saveToJsFile = saveToJsFile;window.downloadJsonData = downloadJsonData;window.loadFromJsFile = loadFromJsFile;window.loadImagesZipOnly = loadImagesZipOnly;window.showChangeLog = showChangeLog;window.hideChangeLog = hideChangeLog;window.exportChangeLog = exportChangeLog;window.clearChangeLog = clearChangeLog;window.addPhotoToRepair = addPhotoToRepair;window.uploadPhotoForRepair = uploadPhotoForRepair;window.editNoteAutoSave = editNoteAutoSave;window.saveNoteAutoSave = saveNoteAutoSave;window.handleNoteKeydown = handleNoteKeydown;window.addFileToDrawing = addFileToDrawing;window.uploadFileForDrawing = uploadFileForDrawing;window.toggleExperienceContent = toggleExperienceContent;window.fixMobileUI = fixMobileUI;window.fixMobileTables = fixMobileTables;window.optimizeMobileTables = optimizeMobileTables;window.setupBackGestureLock = setupBackGestureLock;
