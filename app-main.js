function updateTopButtonsLayout(){const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(isMobile){const topButtons = document.querySelectorAll('.top-btn');topButtons.forEach(btn =>{const text = btn.textContent.trim();if(text === 'ä¿å­˜äº‘ç«¯')btn.textContent = 'äº‘ç«¯ä¿å­˜';if(text === 'åŠ è½½äº‘ç«¯')btn.textContent = 'äº‘ç«¯åŠ è½½';if(text === 'é…ç½®ç®¡ç†')btn.textContent = 'é…ç½®';if(text === 'æ›´æ”¹æ—¥å¿—')btn.textContent = 'æ—¥å¿—'})}}document.addEventListener('DOMContentLoaded',async function(){console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(isMobile){console.log('ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹åˆ°ï¼Œåº”ç”¨ç§»åŠ¨ç«¯ä¼˜åŒ–');document.body.classList.add('mobile-device');setTimeout(updateTopButtonsLayout,100);const style = document.createElement('style');style.textContent = ` .mobile-device{-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}.mobile-device button,.mobile-device input,.mobile-device select,.mobile-device textarea{font-size:16px !important}.mobile-device .data-table-container{-webkit-overflow-scrolling:touch;scrollbar-width:none}.mobile-device .data-table-container::-webkit-scrollbar{display:none}.mobile-device .modal-content{padding-bottom:env(safe-area-inset-bottom,20px)}`;document.head.appendChild(style);setupBackGestureLock()}initTabs();document.getElementById('loginForm').addEventListener('submit',function(e){e.preventDefault();const username = document.getElementById('username').value.trim();const password = document.getElementById('password').value;const user = builtInUsers.find(u => u.username === username && u.password === password);if(user){currentUser = user;document.getElementById('currentUser').textContent = `å½“å‰ç”¨æˆ·ï¼š${user.name}`;document.getElementById('loginPage').style.display = 'none';document.getElementById('mainContainer').classList.remove('hidden');localStorage.setItem('lastUser',JSON.stringify({username:user.username,password:user.password,name:user.name,loginTime:new Date().toISOString()}));autoLoadData();renderSiteList();addChangeLog('ç™»å½•ç³»ç»Ÿ','ç”¨æˆ·ç™»å½•æˆåŠŸ');setTimeout(async()=>{const hasConfig = await loadGithubConfig();if(!hasConfig){console.log('GitHubé…ç½®æœªå®Œæˆï¼ŒåŒæ­¥åŠŸèƒ½ä¸å¯ç”¨')}},1000);if(isMobile){setTimeout(()=>{showSimpleToast(`æ¬¢è¿å›æ¥ï¼Œ${user.name}ï¼`)},500)}}else{const errorDiv = document.getElementById('loginError');errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼';errorDiv.style.display = 'block';if(isMobile && navigator.vibrate){navigator.vibrate(200)}}});const lastUser = localStorage.getItem('lastUser');if(lastUser){try{const userData = JSON.parse(lastUser);const user = builtInUsers.find(u => u.username === userData.username && u.password === userData.password);if(user){document.getElementById('username').value = user.username}}catch(e){console.log('è‡ªåŠ¨ç™»å½•ä¿¡æ¯æ— æ•ˆ')}}});function initTabs(){const tabs = [{id:'progressTab',name:'è¿›åº¦'},{id:'todoTab',name:'å¾…åŠ'},{id:'expenseTab',name:'æ”¯å‡º'},{id:'requirementTab',name:'å®¢æˆ·è¦æ±‚'},{id:'repairTab',name:'å¾…ç»´ä¿®'},{id:'workerTab',name:'å·¥äºº'},{id:'quoteTab',name:'æŠ¥ä»·'},{id:'addRemoveTab',name:'å¢å‡é¡¹'},{id:'drawingTab',name:'å›¾çº¸'},{id:'experienceTab',name:'ç»éªŒæ€»ç»“'}];const tabsContainer = document.getElementById('siteTabs');if(!tabsContainer){console.error('æ‰¾ä¸åˆ° siteTabs å®¹å™¨');return}tabsContainer.innerHTML = '';tabs.forEach((tab,index)=>{const tabElement = document.createElement('div');tabElement.className = `tab ${index === 0 ? 'active':''}`;tabElement.textContent = tab.name;tabElement.setAttribute('data-tab',tab.id);tabElement.onclick =(e)=>{e.stopPropagation();console.log('åˆ‡æ¢æ ‡ç­¾é¡µ:',tab.id);switchTab(tab.id)};tabsContainer.appendChild(tabElement)});const firstTabContent = document.getElementById(tabs[0].id);if(firstTabContent){firstTabContent.classList.add('active')}}function switchTab(tabId){console.log('åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:',tabId);document.querySelectorAll('.tab-content').forEach(content =>{content.classList.remove('active')});document.querySelectorAll('.tab').forEach(tab =>{tab.classList.remove('active')});const targetTab = document.getElementById(tabId);if(targetTab){targetTab.classList.add('active');console.log('å·²æ¿€æ´»æ ‡ç­¾å†…å®¹:',tabId)}else{console.error('æ‰¾ä¸åˆ°æ ‡ç­¾å†…å®¹:',tabId)}const targetTabButton = document.querySelector(`.tab[data-tab="\u0024\u007b\u0074\u0061\u0062\u0049\u0064\u007d"]`);if(targetTabButton){targetTabButton.classList.add('active');targetTabButton.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'})}}function renderSiteList(){const siteList = document.getElementById('siteList');siteList.innerHTML = '';if(sites.length === 0){siteList.innerHTML = '<p class="\u006c\u006f\u0061\u0064\u0069\u006e\u0067">æš‚æ— å·¥åœ°æ•°æ®ï¼Œè¯·æ·»åŠ å·¥åœ°</p>';return}sites.forEach(site =>{const progress = site.progress || 0;const daysLeft = calculateDaysLeft(site.endDate);const status = getSiteStatus(progress,daysLeft);const deleteBtnHtml = canDelete()? `<button class="\u0073\u0069\u0074\u0065\u002d\u0064\u0065\u006c\u0065\u0074\u0065\u002d\u0062\u0074\u006e" onclick="\u0065\u0076\u0065\u006e\u0074\u002e\u0073\u0074\u006f\u0070\u0050\u0072\u006f\u0070\u0061\u0067\u0061\u0074\u0069\u006f\u006e\u0028\u0029\u003b\u0064\u0065\u006c\u0065\u0074\u0065\u0053\u0069\u0074\u0065\u0028\u0027\u0024\u007b\u0073\u0069\u0074\u0065\u002e\u0069\u0064\u007d\u0027\u0029" title="\u5220\u9664\u5de5\u5730">Ã—</button>`:'';const siteCard = document.createElement('div');siteCard.className = 'site-card';siteCard.innerHTML = ` <div class="\u0073\u0069\u0074\u0065\u002d\u0063\u0061\u0072\u0064\u002d\u0068\u0065\u0061\u0064\u0065\u0072"> <div class="\u0073\u0069\u0074\u0065\u002d\u006e\u0061\u006d\u0065">${site.name || 'æœªå‘½åå·¥åœ°'}</div> <div class="\u0073\u0069\u0074\u0065\u002d\u0063\u0061\u0072\u0064\u002d\u0061\u0063\u0074\u0069\u006f\u006e\u0073"> <div class="\u0073\u0069\u0074\u0065\u002d\u0073\u0074\u0061\u0074\u0075\u0073\u0020\u0073\u0074\u0061\u0074\u0075\u0073\u002d\u0024\u007b\u0073\u0074\u0061\u0074\u0075\u0073\u002e\u0063\u006c\u0061\u0073\u0073\u007d">${status.text}</div> ${deleteBtnHtml}</div> </div> <div class="\u0073\u0069\u0074\u0065\u002d\u0069\u006e\u0066\u006f"> <div>å¼€å·¥ï¼š${formatDate(site.startDate)|| 'æœªè®¾ç½®'}</div> <div>è®¡åˆ’å®Œå·¥ï¼š${formatDate(site.endDate)|| 'æœªè®¾ç½®'}</div> <div>è¿›åº¦ï¼š${progress}%</div> <div>å‰©ä½™ï¼š${daysLeft > 0 ? daysLeft + 'å¤©':'å·²é€¾æœŸ'}</div> </div> <div class="\u0070\u0072\u006f\u0067\u0072\u0065\u0073\u0073\u002d\u0062\u0061\u0072" style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0031\u0030\u0070\u0078\u003b\u0068\u0065\u0069\u0067\u0068\u0074\u003a\u0031\u0036\u0070\u0078\u003b"> <div class="\u0070\u0072\u006f\u0067\u0072\u0065\u0073\u0073\u002d\u0066\u0069\u006c\u006c" style="\u0077\u0069\u0064\u0074\u0068\u003a\u0024\u007b\u0070\u0072\u006f\u0067\u0072\u0065\u0073\u0073\u007d\u0025\u003b\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0030\u0070\u0078\u003b\u006c\u0069\u006e\u0065\u002d\u0068\u0065\u0069\u0067\u0068\u0074\u003a\u0031\u0036\u0070\u0078\u003b">${progress}%</div> </div> `;siteCard.onclick =()=> showSiteDetails(site.id);siteList.appendChild(siteCard)})}function showAddSiteModal(){currentSiteId = null;document.getElementById('modalTitle').textContent = 'æ·»åŠ å·¥åœ°';document.getElementById('siteModal').style.display = 'block';clearSiteForm();switchTab('progressTab');clearAllLists()}function clearAllLists(){const site ={todos:[],expenses:[],requirements:[],repairs:[],workers:[],addRemoveItems:[],drawings:[],experiences:[]};renderTodoList(site);renderExpenseList(site);renderRequirementList(site);renderRepairList(site);renderWorkerList(site);renderAddRemoveList(site);renderDrawingList(site);renderExperienceList(site);updateQuoteSummary(site);updateAddRemoveSummary(site)}function showSiteDetails(siteId){currentSiteId = siteId;const site = sites.find(s => s.id === siteId);if(!site){alert('å·¥åœ°ä¸å­˜åœ¨ï¼');return}document.getElementById('modalTitle').textContent = `å·¥åœ°è¯¦æƒ… - ${site.name}`;document.getElementById('siteModal').style.display = 'block';document.body.style.overflow = 'hidden';loadSiteData(site);switchTab('progressTab');if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){setTimeout(()=>{optimizeMobileTables()},100)}}function clearSiteForm(){document.getElementById('siteName').value = '';document.getElementById('startDate').value = '';document.getElementById('endDate').value = '';document.getElementById('progress').value = '0';document.getElementById('progressFill').style.width = '0%';document.getElementById('progressFill').textContent = '0%';document.getElementById('todoItem').value = '';document.getElementById('todoNote').value = ''}function loadSiteData(site){document.getElementById('siteName').value = site.name || '';document.getElementById('startDate').value = formatDate(site.startDate)|| '';document.getElementById('endDate').value = formatDate(site.endDate)|| '';document.getElementById('progress').value = site.progress || 0;updateProgressBar(site.progress || 0);document.getElementById('basicQuote').value = site.basicQuote || 0;document.getElementById('materialQuote').value = site.materialQuote || 0;document.getElementById('equipmentQuote').value = site.equipmentQuote || 0;document.getElementById('furnitureQuote').value = site.furnitureQuote || 0;document.getElementById('otherQuote').value = site.otherQuote || 0;renderTodoList(site);renderExpenseList(site);renderRequirementList(site);renderRepairList(site);renderWorkerList(site);renderAddRemoveList(site);renderDrawingList(site);renderExperienceList(site);updateQuoteSummary(site);updateAddRemoveSummary(site)}function updateProgressValue(value){document.getElementById('progressValue').textContent = value;updateProgressBar(value)}function updateProgressBar(progress){const progressFill = document.getElementById('progressFill');progressFill.style.width = progress + '%';progressFill.textContent = progress + '%'}function saveSiteInfo(){if(!currentSiteId){const newSite ={id:generateId(),name:document.getElementById('siteName').value || 'æœªå‘½åå·¥åœ°',startDate:document.getElementById('startDate').value,endDate:document.getElementById('endDate').value,progress:parseInt(document.getElementById('progress').value)|| 0,todos:[],expenses:[],requirements:[],repairs:[],workers:[],addRemoveItems:[],drawings:[],experiences:[],basicQuote:0,materialQuote:0,equipmentQuote:0,furnitureQuote:0,otherQuote:0,addRemoveTotal:0,totalQuote:0,maxImageDimension:800,dataVersion:'2.0'};sites.push(newSite);currentSiteId = newSite.id;addChangeLog('åˆ›å»ºå·¥åœ°',`åˆ›å»ºäº†å·¥åœ°ï¼š${newSite.name}`)}else{const site = sites.find(s => s.id === currentSiteId);if(site){const oldProgress = site.progress;site.name = document.getElementById('siteName').value || site.name;site.startDate = document.getElementById('startDate').value;site.endDate = document.getElementById('endDate').value;site.progress = parseInt(document.getElementById('progress').value)|| 0;if(!site.maxImageDimension){site.maxImageDimension = 800}if(oldProgress !== site.progress){addChangeLog('æ›´æ–°è¿›åº¦',`å·¥åœ°"\u0024\u007b\u0073\u0069\u0074\u0065\u002e\u006e\u0061\u006d\u0065\u007d"è¿›åº¦ä»${oldProgress}%æ›´æ–°åˆ°${site.progress}%`)}}}saveData();renderSiteList();alert('å·¥åœ°ä¿¡æ¯ä¿å­˜æˆåŠŸï¼')}function deleteSite(siteId){if(!canDelete()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å·¥åœ°ï¼');return}if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥åœ°å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤è¯¥å·¥åœ°çš„æ‰€æœ‰ç›¸å…³æ•°æ®ï¼ˆæ”¯å‡ºã€å·¥äººã€ç»´ä¿®é¡¹ç­‰ï¼‰ï¼Œä¸”ä¸å¯æ¢å¤ï¼')){return}const siteIndex = sites.findIndex(s => s.id === siteId);if(siteIndex === -1){alert('å·¥åœ°ä¸å­˜åœ¨ï¼');return}const siteName = sites[siteIndex].name;sites.splice(siteIndex,1);saveData();if(currentSiteId === siteId){closeSiteModal();currentSiteId = null}renderSiteList();addChangeLog('åˆ é™¤å·¥åœ°',`åˆ é™¤äº†å·¥åœ°ï¼š"\u0024\u007b\u0073\u0069\u0074\u0065\u004e\u0061\u006d\u0065\u007d"`);alert('å·¥åœ°åˆ é™¤æˆåŠŸï¼')}function addTodo(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const item = document.getElementById('todoItem').value;const note = document.getElementById('todoNote').value;if(!item){alert('è¯·å¡«å†™äº‹é¡¹åç§°ï¼');return}const todo ={id:generateId(),item:item,operator:currentUser.name,status:'pending',time:new Date().toISOString().split('T')[0],note:note};if(!site.todos)site.todos = [];site.todos.push(todo);saveData();document.getElementById('todoItem').value = '';document.getElementById('todoNote').value = '';renderTodoList(site);addChangeLog('æ·»åŠ å¾…åŠäº‹é¡¹',`æ·»åŠ äº†å¾…åŠäº‹é¡¹ï¼š${item}`);alert('å¾…åŠäº‹é¡¹æ·»åŠ æˆåŠŸï¼')}function addExpense(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const item = document.getElementById('expenseItem').value;const amount = parseFloat(document.getElementById('expenseAmount').value)|| 0;const unit = 'é¡¹';const note = document.getElementById('expenseNote').value;if(!item || amount <= 0){alert('è¯·å¡«å†™å®Œæ•´çš„æ”¯å‡ºä¿¡æ¯ï¼');return}const expense ={id:generateId(),item:item,amount:amount,unit:unit,note:note,time:new Date().toISOString().split('T')[0],operator:currentUser.name};site.expenses.push(expense);saveData();document.getElementById('expenseItem').value = '';document.getElementById('expenseAmount').value = '';document.getElementById('expenseNote').value = '';renderExpenseList(site);addChangeLog('æ·»åŠ æ”¯å‡º',`æ·»åŠ äº†æ”¯å‡ºé¡¹ï¼š${item}ï¼Œé‡‘é¢ï¼šÂ¥${amount}`);alert('æ”¯å‡ºæ·»åŠ æˆåŠŸï¼')}function addRequirement(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const content = document.getElementById('requirementContent').value;const type = document.getElementById('requirementType').value;const note = document.getElementById('requirementNote').value;if(!content){alert('è¯·å¡«å†™è¦æ±‚å†…å®¹ï¼');return}const requirement ={id:generateId(),content:content,type:type,note:note,status:'pending',time:new Date().toISOString().split('T')[0],operator:currentUser.name};if(!site.requirements)site.requirements = [];site.requirements.push(requirement);saveData();document.getElementById('requirementContent').value = '';document.getElementById('requirementNote').value = '';document.getElementById('requirementType').value = 'need';renderRequirementList(site);addChangeLog('æ·»åŠ å®¢æˆ·è¦æ±‚',`æ·»åŠ äº†å®¢æˆ·è¦æ±‚ï¼š${content.substring(0,12)}...ï¼ˆç±»å‹ï¼š${type === 'need' ? 'éœ€è¦':'æ’é™¤'}ï¼‰`);alert('å®¢æˆ·è¦æ±‚æ·»åŠ æˆåŠŸï¼')}function addRepair(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const content = document.getElementById('repairContent').value;const note = document.getElementById('repairNote').value;const preview = document.getElementById('repairPhotoPreview');const photoData = preview.dataset.originalData;if(!content){alert('è¯·å¡«å†™ç»´ä¿®å†…å®¹ï¼');return}const repair ={id:generateId(),content:content,note:note,photo:photoData || '',photoName:preview.dataset.fileName || '',status:'pending',time:new Date().toISOString().split('T')[0],operator:currentUser.name};if(!site.repairs)site.repairs = [];site.repairs.push(repair);saveData();document.getElementById('repairContent').value = '';document.getElementById('repairNote').value = '';document.getElementById('repairPhoto').value = '';document.getElementById('repairPhotoPreview').innerHTML = '';delete preview.dataset.originalData;delete preview.dataset.fileName;renderRepairList(site);addChangeLog('æ·»åŠ ç»´ä¿®é¡¹',`æ·»åŠ äº†ç»´ä¿®é¡¹ï¼š${content.substring(0,20)}...`);alert('ç»´ä¿®é¡¹æ·»åŠ æˆåŠŸï¼')}function addWorker(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const name = document.getElementById('workerName').value;const type = document.getElementById('workerType').value;const startTime = document.getElementById('workerStartTime').value;const endTime = document.getElementById('workerEndTime').value;const note = document.getElementById('workerNote').value;if(!name || !type || !startTime){alert('è¯·å¡«å†™å®Œæ•´çš„å·¥äººä¿¡æ¯ï¼');return}const worker ={id:generateId(),name:name,type:type,startTime:startTime,endTime:endTime,note:note,rating:1,time:new Date().toISOString().split('T')[0],operator:currentUser.name};site.workers.push(worker);saveData();document.getElementById('workerName').value = '';document.getElementById('workerType').value = '';document.getElementById('workerStartTime').value = '';document.getElementById('workerEndTime').value = '';document.getElementById('workerNote').value = '';renderWorkerList(site);addChangeLog('æ·»åŠ å·¥äºº',`æ·»åŠ äº†å·¥äººï¼š${name}ï¼ˆ${type}ï¼‰`);alert('å·¥äººæ·»åŠ æˆåŠŸï¼')}function addAddRemoveItem(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const item = document.getElementById('addRemoveItem').value;const type = document.getElementById('addRemoveType').value;const amount = parseFloat(document.getElementById('addRemoveAmount').value)|| 0;const unit = 'é¡¹';const note = document.getElementById('addRemoveNote').value;if(!item || amount <= 0){alert('è¯·å¡«å†™å®Œæ•´çš„å¢å‡é¡¹ä¿¡æ¯ï¼');return}const addRemoveItem ={id:generateId(),item:item,type:type,amount:amount,unit:unit,note:note,time:new Date().toISOString().split('T')[0],operator:currentUser.name};site.addRemoveItems.push(addRemoveItem);saveData();document.getElementById('addRemoveItem').value = '';document.getElementById('addRemoveAmount').value = '';document.getElementById('addRemoveNote').value = '';renderAddRemoveList(site);updateAddRemoveSummary(site);updateQuoteSummary(site);addChangeLog('æ·»åŠ å¢å‡é¡¹',`æ·»åŠ äº†${type === 'add' ? 'å¢åŠ ':'å‡å°‘'}é¡¹ï¼š${item}ï¼Œé‡‘é¢ï¼šÂ¥${amount}`);alert('å¢å‡é¡¹æ·»åŠ æˆåŠŸï¼')}function uploadDrawing(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const type = document.getElementById('drawingType').value;const note = document.getElementById('drawingNote').value;const preview = document.getElementById('drawingPreview');const fileData = preview.dataset.originalData;const fileName = preview.dataset.fileName;if(!fileData){alert('è¯·ä¸Šä¼ å›¾çº¸ï¼');return}const drawing ={id:generateId(),type:type,note:note,file:fileData,fileName:fileName || 'æœªå‘½åæ–‡ä»¶',fileType:preview.dataset.fileType || 'application/octet-stream',fileSize:preview.dataset.fileSize || 0,time:new Date().toISOString().split('T')[0],operator:currentUser.name,siteName:site.name};if(!site.drawings)site.drawings = [];site.drawings.push(drawing);saveData();document.getElementById('drawingFile').value = '';document.getElementById('drawingPreview').innerHTML = '';delete preview.dataset.originalData;delete preview.dataset.fileName;delete preview.dataset.fileType;delete preview.dataset.fileSize;document.getElementById('drawingNote').value = '';renderDrawingList(site);addChangeLog('ä¸Šä¼ å›¾çº¸',`ä¸Šä¼ äº†${getDrawingTypeText(type)}å›¾çº¸ï¼š${fileName || 'æœªå‘½åæ–‡ä»¶'}`);alert('å›¾çº¸ä¸Šä¼ æˆåŠŸï¼')}function addExperience(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const content = document.getElementById('experienceContent').value;if(!content){alert('è¯·å¡«å†™ç»éªŒæ€»ç»“å†…å®¹ï¼');return}const experience ={id:generateId(),content:content,time:new Date().toISOString().split('T')[0],operator:currentUser.name};if(!site.experiences)site.experiences = [];site.experiences.push(experience);saveData();document.getElementById('experienceContent').value = '';renderExperienceList(site);addChangeLog('æ·»åŠ ç»éªŒæ€»ç»“',`æ·»åŠ äº†ç»éªŒæ€»ç»“`);alert('ç»éªŒæ€»ç»“æ·»åŠ æˆåŠŸï¼')}function updateTodoStatus(todoId,newStatus){if(!canEditStatus()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ”¹çŠ¶æ€ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const todo = site.todos.find(t => t.id === todoId);if(todo){const oldStatus = todo.status;todo.status = newStatus;saveData();renderTodoList(site);addChangeLog('æ›´æ–°å¾…åŠçŠ¶æ€',`å°†å¾…åŠäº‹é¡¹"\u0024\u007b\u0074\u006f\u0064\u006f\u002e\u0069\u0074\u0065\u006d\u007d"ä»${oldStatus}æ”¹ä¸º${newStatus}`)}}function updateRequirementStatus(reqId,newStatus){if(!canEditStatus()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ”¹çŠ¶æ€ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const req = site.requirements.find(r => r.id === reqId);if(req){const oldStatus = req.status;req.status = newStatus;saveData();renderRequirementList(site);const typeText = req.type === 'need' ? 'éœ€è¦':'æ’é™¤';addChangeLog('æ›´æ–°å®¢æˆ·è¦æ±‚çŠ¶æ€',`å°†å®¢æˆ·è¦æ±‚"\u0024\u007b\u0072\u0065\u0071\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d"ï¼ˆ${typeText}ï¼‰ä»${oldStatus}æ”¹ä¸º${newStatus}`)}}function completeRepair(repairId){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const repair = site.repairs.find(r => r.id === repairId);if(repair){repair.status = 'completed';saveData();renderRepairList(site);addChangeLog('å®Œæˆç»´ä¿®',`å®Œæˆäº†ç»´ä¿®é¡¹ï¼š${repair.content.substring(0,20)}...`);alert('ç»´ä¿®é¡¹å·²æ ‡è®°ä¸ºå®Œæˆï¼')}}function updateRepairStatus(repairId,newStatus){if(!canEditStatus()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ›´æ”¹çŠ¶æ€ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const repair = site.repairs.find(r => r.id === repairId);if(repair){const oldStatus = repair.status;repair.status = newStatus;saveData();renderRepairList(site);addChangeLog('æ›´æ–°ç»´ä¿®çŠ¶æ€',`å°†ç»´ä¿®é¡¹"\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d"ä»${oldStatus}æ”¹ä¸º${newStatus}`)}}function updateWorkerRating(workerId,rating){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const worker = site.workers.find(w => w.id === workerId);if(worker){worker.rating = rating;saveData();renderWorkerList(site);addChangeLog('æ›´æ–°å·¥äººè¯„ä»·',`æ›´æ–°äº†å·¥äºº"\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u006e\u0061\u006d\u0065\u007d"çš„è¯„ä»·ä¸º${rating}æ˜Ÿ`)}}function editWorkerTime(workerId,cell,type){const display = cell.querySelector('.date-display');const input = cell.querySelector('.date-edit');display.style.display = 'none';input.style.display = 'inline-block';input.focus()}function saveWorkerTime(workerId,newTime,type){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const worker = site.workers.find(w => w.id === workerId);if(worker){if(type === 'startTime'){worker.startTime = newTime;addChangeLog('ç¼–è¾‘å·¥äººå¼€å§‹æ—¶é—´',`ä¿®æ”¹äº†å·¥äºº"\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u006e\u0061\u006d\u0065\u007d"çš„å¼€å§‹æ—¶é—´ä¸ºï¼š${newTime}`)}else if(type === 'endTime'){worker.endTime = newTime;addChangeLog('ç¼–è¾‘å·¥äººç»“æŸæ—¶é—´',`ä¿®æ”¹äº†å·¥äºº"\u0024\u007b\u0077\u006f\u0072\u006b\u0065\u0072\u002e\u006e\u0061\u006d\u0065\u007d"çš„ç»“æŸæ—¶é—´ä¸ºï¼š${newTime}`)}saveData();renderWorkerList(site)}}function previewRepairPhoto(event){const file = event.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');event.target.value = '';return}if(file.size > 10 * 1024 * 1024){alert('å›¾ç‰‡å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡ï¼');event.target.value = '';return}resizeImage(file,500,function(resizedDataUrl){const preview = document.getElementById('repairPhotoPreview');preview.innerHTML = ` <div style="\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u003b"> <img src="\u0024\u007b\u0072\u0065\u0073\u0069\u007a\u0065\u0064\u0044\u0061\u0074\u0061\u0055\u0072\u006c\u007d" class="\u0069\u006d\u0061\u0067\u0065\u002d\u0070\u0072\u0065\u0076\u0069\u0065\u0077" onclick="\u0076\u0069\u0065\u0077\u0049\u006d\u0061\u0067\u0065\u0028\u0027\u0024\u007b\u0072\u0065\u0073\u0069\u007a\u0065\u0064\u0044\u0061\u0074\u0061\u0055\u0072\u006c\u007d\u0027\u0029"> <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0035\u0070\u0078\u003b\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0032\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0036\u003b"> ${file.name}<br> <small>å·²å‹ç¼©:æœ€å¤§è¾¹500px,è´¨é‡0.6</small> </div> </div> `;preview.dataset.originalData = resizedDataUrl;preview.dataset.fileName = file.name})}function previewDrawing(event){const file = event.target.files[0];if(!file)return;const preview = document.getElementById('drawingPreview');const reader = new FileReader();reader.onload = function(e){const dataUrl = e.target.result;preview.dataset.originalData = dataUrl;preview.dataset.fileName = file.name;preview.dataset.fileType = file.type;preview.dataset.fileSize = file.size;if(file.type.startsWith('image/')){resizeImage(file,500,function(resizedDataUrl){preview.innerHTML = ` <div style="\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u003b"> <img src="\u0024\u007b\u0072\u0065\u0073\u0069\u007a\u0065\u0064\u0044\u0061\u0074\u0061\u0055\u0072\u006c\u007d" class="\u0069\u006d\u0061\u0067\u0065\u002d\u0070\u0072\u0065\u0076\u0069\u0065\u0077" onclick="\u0076\u0069\u0065\u0077\u0049\u006d\u0061\u0067\u0065\u0028\u0027\u0024\u007b\u0072\u0065\u0073\u0069\u007a\u0065\u0064\u0044\u0061\u0074\u0061\u0055\u0072\u006c\u007d\u0027\u0029"> <div style="\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0035\u0070\u0078\u003b\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0032\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0036\u003b"> ${file.name}(${(file.size / 1024).toFixed(1)}KB)<br><small>å·²å‹ç¼©:æœ€å¤§è¾¹500px,è´¨é‡0.6</small> </div> </div> `;preview.dataset.originalData = resizedDataUrl})}else{let icon = 'ğŸ“„';let typeText = 'æ–‡æ¡£';if(file.type.includes('pdf')){icon = 'ğŸ“•';typeText = 'PDFæ–‡ä»¶'}else if(file.type.includes('excel')|| file.type.includes('sheet')){icon = 'ğŸ“Š';typeText = 'Excelæ–‡ä»¶'}else if(file.type.includes('word')){icon = 'ğŸ“';typeText = 'Wordæ–‡ä»¶'}else if(file.type.includes('csv')){icon = 'ğŸ“‹';typeText = 'CSVæ–‡ä»¶'}preview.innerHTML = ` <div style="\u0074\u0065\u0078\u0074\u002d\u0061\u006c\u0069\u0067\u006e\u003a\u0063\u0065\u006e\u0074\u0065\u0072\u003b\u0070\u0061\u0064\u0064\u0069\u006e\u0067\u003a\u0031\u0030\u0070\u0078\u003b"> <div style="\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0034\u0038\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0037\u0065\u0065\u0061\u003b">${icon}</div> <div style="\u0066\u006f\u006e\u0074\u002d\u0077\u0065\u0069\u0067\u0068\u0074\u003a\u0062\u006f\u006c\u0064\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u003a\u0031\u0030\u0070\u0078\u0020\u0030\u003b">${typeText}</div> <div style="\u0077\u006f\u0072\u0064\u002d\u0062\u0072\u0065\u0061\u006b\u003a\u0062\u0072\u0065\u0061\u006b\u002d\u0061\u006c\u006c\u003b">${file.name}</div> <div style="\u0066\u006f\u006e\u0074\u002d\u0073\u0069\u007a\u0065\u003a\u0031\u0032\u0070\u0078\u003b\u0063\u006f\u006c\u006f\u0072\u003a\u0023\u0036\u0036\u0036\u003b\u006d\u0061\u0072\u0067\u0069\u006e\u002d\u0074\u006f\u0070\u003a\u0035\u0070\u0078\u003b"> ${(file.size / 1024).toFixed(1)}KB </div> </div> `}};reader.readAsDataURL(file)}function changeRepairPhoto(repairId,button){const fileInput = button.parentElement.querySelector('.repair-photo-input');fileInput.click()}function uploadNewRepairPhoto(repairId,fileInput){const file = fileInput.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');return}resizeImage(file,500,function(resizedDataUrl){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const repair = site.repairs.find(r => r.id === repairId);if(repair){const oldPhotoInfo = repair.photo ? 'æœ‰å›¾ç‰‡':'æ— å›¾ç‰‡';repair.photo = resizedDataUrl;repair.photoName = file.name;saveData();renderRepairList(site);addChangeLog('æ›´æ¢ç»´ä¿®å›¾ç‰‡',`æ›´æ¢äº†ç»´ä¿®é¡¹"\u0024\u007b\u0072\u0065\u0070\u0061\u0069\u0072\u002e\u0063\u006f\u006e\u0074\u0065\u006e\u0074\u007d"çš„å›¾ç‰‡ï¼ˆæ—§ï¼š${oldPhotoInfo}ï¼‰`);alert('ç»´ä¿®å›¾ç‰‡æ›´æ¢æˆåŠŸï¼')}})}function changeDrawingFile(drawingId,button){const fileInput = button.parentElement.querySelector('.drawing-file-input');fileInput.click()}function uploadNewDrawingFile(drawingId,fileInput){const file = fileInput.files[0];if(!file)return;console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶:',file.name,'ç±»å‹:',file.type,'å¤§å°:',file.size);const site = sites.find(s => s.id === currentSiteId);if(!site){console.error('æœªæ‰¾åˆ°å½“å‰å·¥åœ°');return}const drawing = site.drawings.find(d => d.id === drawingId);if(!drawing){console.error('æœªæ‰¾åˆ°å›¾çº¸');return}const oldFileName = drawing.fileName || 'æœªå‘½å';if(file.type.startsWith('image/')){console.log('å¤„ç†å›¾ç‰‡æ–‡ä»¶');resizeImage(file,500,function(resizedDataUrl){console.log('å›¾ç‰‡å‹ç¼©å®Œæˆï¼Œå¼€å§‹æ›´æ–°å›¾çº¸æ•°æ®');drawing.file = resizedDataUrl;drawing.fileName = file.name;drawing.fileType = file.type;drawing.fileSize = file.size;saveData();renderDrawingList(site);addChangeLog('æ›´æ¢å›¾çº¸æ–‡ä»¶',`æ›´æ¢äº†${getDrawingTypeText(drawing.type)}å›¾çº¸ï¼š${oldFileName}â†’ ${file.name}`);console.log('å›¾çº¸æ–‡ä»¶æ›´æ¢æˆåŠŸï¼');alert('å›¾çº¸æ–‡ä»¶æ›´æ¢æˆåŠŸï¼')})}else{console.log('å¤„ç†éå›¾ç‰‡æ–‡ä»¶');const reader = new FileReader();reader.onload = function(e){console.log('æ–‡ä»¶è¯»å–å®Œæˆ');drawing.file = e.target.result;drawing.fileName = file.name;drawing.fileType = file.type;drawing.fileSize = file.size;saveData();renderDrawingList(site);addChangeLog('æ›´æ¢å›¾çº¸æ–‡ä»¶',`æ›´æ¢äº†${getDrawingTypeText(drawing.type)}å›¾çº¸ï¼š${oldFileName}â†’ ${file.name}`);console.log('å›¾çº¸æ–‡ä»¶æ›´æ¢æˆåŠŸï¼');alert('å›¾çº¸æ–‡ä»¶æ›´æ¢æˆåŠŸï¼')};reader.onerror = function(e){console.error('æ–‡ä»¶è¯»å–å¤±è´¥:',e);alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•')};reader.readAsDataURL(file)}}function saveQuote(){if(!currentSiteId){alert('è¯·å…ˆä¿å­˜å·¥åœ°åŸºæœ¬ä¿¡æ¯ï¼');return}if(!canEditQuote()){alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥å¡«å†™æŠ¥ä»·ï¼');return}const site = sites.find(s => s.id === currentSiteId);if(!site)return;const basicQuote = parseFloat(document.getElementById('basicQuote').value)|| 0;const materialQuote = parseFloat(document.getElementById('materialQuote').value)|| 0;const equipmentQuote = parseFloat(document.getElementById('equipmentQuote').value)|| 0;const furnitureQuote = parseFloat(document.getElementById('furnitureQuote').value)|| 0;const otherQuote = parseFloat(document.getElementById('otherQuote').value)|| 0;const addRemoveTotal = parseFloat(document.getElementById('addRemoveTotalQuote').value)|| 0;site.basicQuote = basicQuote;site.materialQuote = materialQuote;site.equipmentQuote = equipmentQuote;site.furnitureQuote = furnitureQuote;site.otherQuote = otherQuote;site.addRemoveTotal = addRemoveTotal;site.totalQuote = basicQuote + materialQuote + equipmentQuote + furnitureQuote + otherQuote + addRemoveTotal;saveData();updateQuoteSummary(site);addChangeLog('æ›´æ–°æŠ¥ä»·',`æ›´æ–°äº†å·¥åœ°"\u0024\u007b\u0073\u0069\u0074\u0065\u002e\u006e\u0061\u006d\u0065\u007d"çš„æŠ¥ä»·ä¿¡æ¯`);alert('æŠ¥ä»·ä¿å­˜æˆåŠŸï¼')}function updateQuoteSummary(site){if(!site)return;const addRemoveTotal = site.addRemoveItems?.reduce((sum,item)=>{return sum +(item.type === 'add' ? item.amount:-item.amount)},0)|| 0;site.addRemoveTotal = addRemoveTotal;const basicQuote = site.basicQuote || 0;const materialQuote = site.materialQuote || 0;const equipmentQuote = site.equipmentQuote || 0;const furnitureQuote = site.furnitureQuote || 0;const otherQuote = site.otherQuote || 0;const totalQuote = basicQuote + materialQuote + equipmentQuote + furnitureQuote + otherQuote + addRemoveTotal;site.totalQuote = totalQuote;document.getElementById('basicQuoteDisplay').textContent = `Â¥${basicQuote.toFixed(2)}`;document.getElementById('materialQuoteDisplay').textContent = `Â¥${materialQuote.toFixed(2)}`;document.getElementById('equipmentQuoteDisplay').textContent = `Â¥${equipmentQuote.toFixed(2)}`;document.getElementById('furnitureQuoteDisplay').textContent = `Â¥${furnitureQuote.toFixed(2)}`;document.getElementById('otherQuoteDisplay').textContent = `Â¥${otherQuote.toFixed(2)}`;document.getElementById('addRemoveTotalQuoteDisplay').textContent = `${addRemoveTotal >= 0 ? '+':''}Â¥${addRemoveTotal.toFixed(2)}`;document.getElementById('totalQuoteDisplay').textContent = `Â¥${totalQuote.toFixed(2)}`;document.getElementById('addRemoveTotalQuote').value = addRemoveTotal}function updateAddRemoveSummary(site){if(!site || !site.addRemoveItems){document.getElementById('addRemoveSummary').textContent = 'Â¥0.00';return}const addTotal = site.addRemoveItems .filter(item => item.type === 'add').reduce((sum,item)=> sum +(item.amount || 0),0);const removeTotal = site.addRemoveItems .filter(item => item.type === 'remove').reduce((sum,item)=> sum +(item.amount || 0),0);const total = addTotal - removeTotal;document.getElementById('addRemoveSummary').textContent = `Â¥${total.toFixed(2)}`;site.addRemoveTotal = total;document.getElementById('addRemoveTotalQuote').value = total;document.getElementById('addRemoveTotalQuoteDisplay').textContent = `Â¥${total.toFixed(2)}`}async function loadFromJsFile(){if(!currentUser){alert('è¯·å…ˆç™»å½•ï¼');return}if(!confirm('è­¦å‘Šï¼šä»æ–‡ä»¶åŠ è½½æ•°æ®å°†å®Œå…¨è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼\nè¯·ç¡®ä¿å·²ç»å¤‡ä»½å½“å‰æ•°æ®ã€‚\næ˜¯å¦ç»§ç»­ï¼Ÿ')){return}const input = document.createElement('input');input.type = 'file';input.accept = '.zip,.js,.json';input.onchange = async function(event){const file = event.target.files[0];if(!file)return;try{const reader = new FileReader();reader.onload = async function(e){try{const content = e.target.result;if(file.name.toLowerCase().endsWith('.zip')){await loadFromZipFile(file);showSimpleToast('å®Œæ•´æ•°æ®åŒ…åŠ è½½æˆåŠŸï¼Œæ‰€æœ‰æ–‡ä»¶å·²æ¢å¤')}else if(file.name.toLowerCase().endsWith('.json')){await loadFromJsonContent(content,file.name);showSimpleToast('JSONæ•°æ®åŠ è½½æˆåŠŸï¼Œå›¾ç‰‡éœ€è¦å•ç‹¬æ¢å¤','warning')}else if(file.name.toLowerCase().endsWith('.js')){await loadFromJsContent(content);showSimpleToast('JSæ•°æ®åŠ è½½æˆåŠŸï¼Œå›¾ç‰‡éœ€è¦å•ç‹¬æ¢å¤','warning')}else{alert('è¯·é€‰æ‹© ZIPã€JS æˆ– JSON æ–‡ä»¶ï¼');return}saveData();renderSiteList();addChangeLog('åŠ è½½æ•°æ®',`ä»æ–‡ä»¶ ${file.name}åŠ è½½æ•°æ®`);alert(`æ•°æ®åŠ è½½æˆåŠŸï¼\nå·²åŠ è½½ ${sites.length}ä¸ªå·¥åœ°æ•°æ®ã€‚`)}catch(error){console.error('åŠ è½½å¤±è´¥:',error);alert('åŠ è½½å¤±è´¥ï¼š' + error.message)}};if(file.name.toLowerCase().endsWith('.zip')){reader.readAsArrayBuffer(file)}else{reader.readAsText(file)}}catch(error){console.error('æ–‡ä»¶è¯»å–å¤±è´¥:',error);alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼š' + error.message)}};input.click()}async function loadFromZipFile(file){if(typeof JSZip === 'undefined'){alert('JSZip åº“æœªåŠ è½½ï¼Œæ— æ³•å¤„ç† ZIP æ–‡ä»¶');throw new Error('JSZip åº“æœªåŠ è½½')}const zip = await JSZip.loadAsync(file);let dataFile = null;const possibleDataFiles = [ 'shuju.js','shuju_light.js','construction_data.json' ];for(const fileName of possibleDataFiles){const fileInZip = zip.file(fileName);if(fileInZip){dataFile = fileInZip;console.log(`åœ¨ZIPä¸­æ‰¾åˆ°æ•°æ®æ–‡ä»¶:${fileName}`);break}}if(!dataFile){const allFiles = Object.keys(zip.files);const jsFiles = allFiles.filter(name => name.endsWith('.js'));const jsonFiles = allFiles.filter(name => name.endsWith('.json'));if(jsFiles.length > 0){dataFile = zip.file(jsFiles[0])}else if(jsonFiles.length > 0){dataFile = zip.file(jsonFiles[0])}}if(!dataFile){throw new Error('ZIP æ–‡ä»¶ä¸­æœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶')}const content = await dataFile.async('text');if(dataFile.name.endsWith('.js')){await loadFromJsContent(content)}else if(dataFile.name.endsWith('.json')){await loadFromJsonContent(content,dataFile.name)}await restoreFilesFromZip(zip);console.log('ä» ZIP æ–‡ä»¶åŠ è½½å®Œæ•´æ•°æ®æˆåŠŸ')}async function autoLoadData(){console.log('å¼€å§‹è‡ªåŠ¨åŠ è½½æ•°æ®...');try{console.log('ä» localStorage åŠ è½½...');loadFromLocalStorage();if(sites.length > 0 || changeLog.length > 0){console.log(`ä» localStorage åŠ è½½äº† ${sites.length}ä¸ªå·¥åœ°æ•°æ®`);saveData();if(currentUser){renderSiteList()}console.log('ä» localStorage åŠ è½½å®Œæˆ');return}console.log('localStorage ä¸­æ— æ•°æ®ï¼Œå°è¯•ä» shuju.js åŠ è½½...');const jsLoaded = await tryLoadJsFile();if(jsLoaded){console.log('ä» shuju.js æ–‡ä»¶åŠ è½½æˆåŠŸï¼');saveData();if(currentUser){renderSiteList()}}else{console.log('shuju.js æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ç©ºæ•°æ®');sites = [];changeLog = [];saveData()}}catch(error){console.error('è‡ªåŠ¨åŠ è½½å¤±è´¥:',error);if(!Array.isArray(sites))sites = [];if(!Array.isArray(changeLog))changeLog = [];saveData()}console.log('è‡ªåŠ¨åŠ è½½å®Œæˆ')}async function tryLoadJsFile(){return new Promise((resolve)=>{if(window.location.protocol === 'file:'){console.log('åœ¨æœ¬åœ°æ–‡ä»¶ç¯å¢ƒä¸‹è¿è¡Œï¼Œè·³è¿‡ JS æ–‡ä»¶åŠ è½½');resolve(false);return}const jsFilesToTry = ['shuju.js','shuju_light.js'];let currentIndex = 0;function tryNextFile(){if(currentIndex >= jsFilesToTry.length){console.log('æ‰€æœ‰ JS æ–‡ä»¶å°è¯•åŠ è½½å¤±è´¥');resolve(false);return}const fileName = jsFilesToTry[currentIndex];console.log(`å°è¯•åŠ è½½æ–‡ä»¶:${fileName}`);const script = document.createElement('script');script.src = fileName;script.onload = function(){try{if(typeof savedData !== 'undefined'){console.log(`æˆåŠŸä» ${fileName}åŠ è½½æ•°æ®`);const isLightVersion = fileName === 'shuju_light.js' ||(savedData.dataVersion && savedData.dataVersion.includes('light'))||(savedData.note && savedData.note.includes('æ— base64'));sites = savedData.sites || [];changeLog = savedData.changeLog || [];convertAllTimesToDate();console.log(`ä» ${fileName}åŠ è½½äº† ${sites.length}ä¸ªå·¥åœ°æ•°æ®`);console.log(`æ•°æ®ç‰ˆæœ¬:${savedData.dataVersion || 'æœªçŸ¥'}`);if(isLightVersion){console.log('æ£€æµ‹åˆ°è½»é‡ç‰ˆæ•°æ®ï¼ˆæ— base64å›¾ç‰‡ï¼‰');setTimeout(()=>{showSimpleToast('å·²åŠ è½½æ–‡æœ¬æ•°æ®ï¼Œè¯·åŠ è½½å›¾ç‰‡ZIPåŒ…ä»¥æ¢å¤å›¾ç‰‡','warning')},1000)}delete window.savedData;resolve(true)}else{console.log(`${fileName}ä¸­æ²¡æœ‰æ‰¾åˆ° savedData å˜é‡`);currentIndex++;setTimeout(tryNextFile,100)}}catch(error){console.error(`åŠ è½½ ${fileName}æ—¶å‡ºé”™:`,error);currentIndex++;setTimeout(tryNextFile,100)}};script.onerror = function(){console.log(`${fileName}æ–‡ä»¶ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥`);currentIndex++;setTimeout(tryNextFile,100)};setTimeout(()=>{if(script.parentNode){document.head.removeChild(script);console.log(`åŠ è½½ ${fileName}è¶…æ—¶`);currentIndex++;setTimeout(tryNextFile,100)}},5000);script.loaded = false;const originalOnload = script.onload;const originalOnerror = script.onerror;script.onload = function(){script.loaded = true;originalOnload.call(this)};script.onerror = function(){script.loaded = true;originalOnerror.call(this)};document.head.appendChild(script)}tryNextFile()})}function convertAllTimesToDate(){sites.forEach(site =>{if(site.todos){site.todos.forEach(todo =>{if(todo.time && !todo.time.match(/^\d{4}-\d{2}-\d{2}$/)){todo.time = formatDate(todo.time)}})}if(site.expenses){site.expenses.forEach(expense =>{if(expense.time && !expense.time.match(/^\d{4}-\d{2}-\d{2}$/)){expense.time = formatDate(expense.time)}})}if(site.requirements){site.requirements.forEach(req =>{if(req.time && !req.time.match(/^\d{4}-\d{2}-\d{2}$/)){req.time = formatDate(req.time)}})}if(site.repairs){site.repairs.forEach(repair =>{if(repair.time && !repair.time.match(/^\d{4}-\d{2}-\d{2}$/)){repair.time = formatDate(repair.time)}})}if(site.workers){site.workers.forEach(worker =>{if(worker.time && !worker.time.match(/^\d{4}-\d{2}-\d{2}$/)){worker.time = formatDate(worker.time)}if(worker.startTime && !worker.startTime.match(/^\d{4}-\d{2}-\d{2}$/)){worker.startTime = formatDate(worker.startTime)}if(worker.endTime && !worker.endTime.match(/^\d{4}-\d{2}-\d{2}$/)){worker.endTime = formatDate(worker.endTime)}})}if(site.addRemoveItems){site.addRemoveItems.forEach(item =>{if(item.time && !item.time.match(/^\d{4}-\d{2}-\d{2}$/)){item.time = formatDate(item.time)}})}if(site.drawings){site.drawings.forEach(drawing =>{if(drawing.time && !drawing.time.match(/^\d{4}-\d{2}-\d{2}$/)){drawing.time = formatDate(drawing.time)}})}if(site.experiences){site.experiences.forEach(exp =>{if(exp.time && !exp.time.match(/^\d{4}-\d{2}-\d{2}$/)){exp.time = formatDate(exp.time)}})}})}async function loadFromJsonContent(content,fileName){try{const data = JSON.parse(content);if(!data.sites){throw new Error('JSON æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®')}sites = data.sites || [];changeLog = data.changeLog || [];convertAllTimesToDate();console.log(`ä» JSON æ–‡ä»¶ ${fileName}åŠ è½½äº† ${sites.length}ä¸ªå·¥åœ°æ•°æ®`)}catch(error){console.error('åŠ è½½ JSON å¤±è´¥:',error);throw new Error('æ— æ³•è§£æ JSON æ–‡ä»¶æ ¼å¼')}}async function loadFromJsContent(content){try{const jsonMatch = content.match(/const savedData\s*=\s*(\{[\s\S]*?\});/s);if(jsonMatch && jsonMatch[1]){const data = JSON.parse(jsonMatch[1]);sites = data.sites || [];changeLog = data.changeLog || []}else{const data = JSON.parse(content);if(data.sites){sites = data.sites || [];changeLog = data.changeLog || []}else{throw new Error('æ— æ³•è§£ææ•°æ®æ ¼å¼')}}const hasBase64Images = sites.some(site =>(site.repairs && site.repairs.some(r => r.photo && r.photo.startsWith('data:')))||(site.drawings && site.drawings.some(d => d.file && d.file.startsWith('data:'))));convertAllTimesToDate();console.log(`ä» JS æ–‡ä»¶åŠ è½½äº† ${sites.length}ä¸ªå·¥åœ°æ•°æ®`);console.log(`æ˜¯å¦åŒ…å«Base64å›¾ç‰‡:${hasBase64Images ? 'æ˜¯':'å¦'}`);if(!hasBase64Images){showSimpleToast('å·²åŠ è½½æ–‡æœ¬æ•°æ®ï¼Œå¦‚éœ€å›¾ç‰‡è¯·åŠ è½½å›¾ç‰‡ZIPåŒ…','warning')}}catch(error){console.error('åŠ è½½ JS æ–‡ä»¶å¤±è´¥:',error);throw new Error('æ— æ³•è§£ææ•°æ®æ–‡ä»¶æ ¼å¼')}}async function restoreFilesFromZip(zip){try{const shujuFolder = zip.folder('shuju');if(!shujuFolder){console.log('ZIP ä¸­æ²¡æœ‰ shuju æ–‡ä»¶å¤¹');return}for(const site of sites){const siteName =(site.name || `å·¥åœ°_${site.id}`).replace(/[\\/:*?"<>|]/g,'_');const siteFolder = shujuFolder.folder(siteName);if(!siteFolder)continue;const repairsFolder = siteFolder.folder('repairs');if(site.repairs && repairsFolder){for(const repair of site.repairs){if(repair.photo && repair.photo.startsWith('[PHOTO:')){const fileName = repair.photo.match(/\[PHOTO:(.+?)\]/)[1];const filePath = fileName.split('/').pop();const file = repairsFolder.file(filePath);if(file){const base64 = await file.async('base64');const mimeType = getMimeTypeFromFileName(filePath);repair.photo = `data:${mimeType};base64,${base64}`}}}}const drawingsFolder = siteFolder.folder('drawings');if(site.drawings && drawingsFolder){for(const drawing of site.drawings){if(drawing.file && drawing.file.startsWith('[FILE:')){const fileName = drawing.file.match(/\[FILE:(.+?)\]/)[1];const filePath = fileName.split('/').pop();const file = drawingsFolder.file(filePath);if(file){const base64 = await file.async('base64');const mimeType = getMimeTypeFromFileName(filePath);drawing.file = `data:${mimeType};base64,${base64}`}}}}}console.log('ä» ZIP æ¢å¤æ–‡ä»¶æ•°æ®æˆåŠŸ')}catch(error){console.warn('ä» ZIP æ¢å¤æ–‡ä»¶å¤±è´¥:',error)}}function viewImage(src){document.getElementById('viewerImage').src = src;document.getElementById('imageViewer').style.display = 'block'}function hideImageViewer(){document.getElementById('imageViewer').style.display = 'none'}function downloadDrawing(drawingId){const site = sites.find(s => s.id === currentSiteId);if(!site)return;const drawing = site.drawings.find(d => d.id === drawingId);if(drawing && drawing.file){const a = document.createElement('a');a.href = drawing.file;let fileName = drawing.fileName;if(!fileName){const match = drawing.file.match(/^data:([^;]+);/);if(match){const mimeType = match[1];const extension = getExtensionFromMimeType(mimeType);fileName = `${getDrawingTypeText(drawing.type)}_${drawing.time.replace(/[\/:]/g,'-')}.${extension}`}else{fileName = `${getDrawingTypeText(drawing.type)}_${drawing.time.replace(/[\/:]/g,'-')}`}}a.download = fileName;a.click();addChangeLog('ä¸‹è½½å›¾çº¸',`ä¸‹è½½äº†${getDrawingTypeText(drawing.type)}å›¾çº¸ï¼š${fileName}`)}}async function tryLoadMissingFile(filePath){const input = document.createElement('input');input.type = 'file';input.accept = '.jpg,.jpeg,.png,.gif,.pdf,.xls,.xlsx,.doc,.docx,.csv';input.onchange = async function(event){const file = event.target.files[0];if(!file)return;const reader = new FileReader();reader.onload = function(e){updateFileData(filePath,e.target.result)};reader.readAsDataURL(file)};input.click()}function updateFileData(filePath,base64Data){let updated = false;sites.forEach(site =>{if(site.repairs){site.repairs.forEach(repair =>{if(repair.photo && repair.photo.includes(filePath)){repair.photo = base64Data;delete repair.photoMissing;updated = true;console.log(`å·²æ›´æ–°ç»´ä¿®å›¾ç‰‡:${filePath}`)}})}if(site.drawings){site.drawings.forEach(drawing =>{if(drawing.file && drawing.file.includes(filePath)){drawing.file = base64Data;delete drawing.fileMissing;updated = true;console.log(`å·²æ›´æ–°å›¾çº¸æ–‡ä»¶:${filePath}`)}})}});if(updated){saveData();if(currentSiteId){const site = sites.find(s => s.id === currentSiteId);if(site)loadSiteData(site)}showSimpleToast('æ–‡ä»¶å·²åŠ è½½å¹¶æ›´æ–°')}else{showSimpleToast('æœªæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶è·¯å¾„','error')}}function closeSiteModal(){document.getElementById('siteModal').style.display = 'none';document.body.style.overflow = 'auto';currentSiteId = null;const previews = ['repairPhotoPreview','drawingPreview'];previews.forEach(id =>{const element = document.getElementById(id);if(element){element.innerHTML = '';delete element.dataset.originalData;delete element.dataset.fileName}})}function logout(){if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')){addChangeLog('é€€å‡ºç³»ç»Ÿ','ç”¨æˆ·é€€å‡ºç™»å½•');currentUser = null;document.getElementById('loginPage').style.display = 'flex';document.getElementById('mainContainer').classList.add('hidden');document.getElementById('username').value = '';document.getElementById('password').value = '';document.getElementById('loginError').style.display = 'none'}}window.onclick = function(event){const modal = document.getElementById('siteModal');if(event.target === modal){closeSiteModal()}}document.addEventListener('keydown',function(event){if(event.key === 'Escape'){const modal = document.getElementById('siteModal');if(modal.style.display === 'block'){closeSiteModal()}}});document.addEventListener('DOMContentLoaded',function(){const oldTip = document.getElementById('missingFilesTip');if(oldTip)oldTip.remove()});window.saveToGitHub = saveToGitHub;window.loadFromGitHub = loadFromGitHub;window.saveToJsFile = saveToJsFile;window.downloadJsonData = downloadJsonData;window.loadFromJsFile = loadFromJsFile;window.loadImagesZipOnly = loadImagesZipOnly;window.showChangeLog = showChangeLog;window.hideChangeLog = hideChangeLog;window.exportChangeLog = exportChangeLog;window.clearChangeLog = clearChangeLog;window.logout = logout;window.showAddSiteModal = showAddSiteModal;window.showSiteDetails = showSiteDetails;window.updateProgressValue = updateProgressValue;window.saveSiteInfo = saveSiteInfo;window.addTodo = addTodo;window.addExpense = addExpense;window.addRequirement = addRequirement;window.addRepair = addRepair;window.addWorker = addWorker;window.addAddRemoveItem = addAddRemoveItem;window.uploadDrawing = uploadDrawing;window.addExperience = addExperience;window.updateTodoStatus = updateTodoStatus;window.updateRequirementStatus = updateRequirementStatus;window.completeRepair = completeRepair;window.updateRepairStatus = updateRepairStatus;window.updateWorkerRating = updateWorkerRating;window.editWorkerTime = editWorkerTime;window.saveWorkerTime = saveWorkerTime;window.previewRepairPhoto = previewRepairPhoto;window.previewDrawing = previewDrawing;window.changeRepairPhoto = changeRepairPhoto;window.uploadNewRepairPhoto = uploadNewRepairPhoto;window.changeDrawingFile = changeDrawingFile;window.uploadNewDrawingFile = uploadNewDrawingFile;window.saveQuote = saveQuote;window.updateQuoteSummary = updateQuoteSummary;window.updateAddRemoveSummary = updateAddRemoveSummary;window.viewImage = viewImage;window.hideImageViewer = hideImageViewer;window.closeSiteModal = closeSiteModal;window.downloadDrawing = downloadDrawing;window.tryLoadMissingFile = tryLoadMissingFile;window.updateFileData = updateFileData;window.deleteSite = deleteSite;window.switchTab = switchTab;window.toggleExperienceContent = toggleExperienceContent;
